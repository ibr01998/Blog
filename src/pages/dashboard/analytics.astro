---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import FlipCounter from '../../components/FlipCounter.astro';
import { db, AnalyticsView, AnalyticsClick, Post, eq, desc, sql } from 'astro:db';

// Fetch Data
const views = await db.select().from(AnalyticsView);
const clicks = await db.select().from(AnalyticsClick);
const dbPosts = await db.select().from(Post);

// Fetch File Collection Posts
import { getCollection } from 'astro:content';
const filePosts = await getCollection('blog');

// Normalize and Merge Posts
const allPosts = [
    ...dbPosts,
    ...filePosts.map(p => ({
        slug: p.slug,
        title: p.data.title,
        pubDate: p.data.pubDate
    }))
];

// Deduplicate by slug (prefer DB version if both exist)
const uniquePostsMap = new Map();
allPosts.forEach(p => {
    if(!uniquePostsMap.has(p.slug)) {
        uniquePostsMap.set(p.slug, p);
    }
});
const uniquePosts = Array.from(uniquePostsMap.values());

const totalSiteViews = views.length;
const totalSiteClicks = clicks.length;
const globalTotalDuration = views.reduce((acc, curr) => acc + (curr.duration || 0), 0);
const globalAvgTime = totalSiteViews > 0 ? Math.round(globalTotalDuration / totalSiteViews) : 0;
const globalMinutes = Math.floor(globalAvgTime / 60);
const globalSeconds = globalAvgTime % 60;

// Format Total Time
const totalHours = Math.floor(globalTotalDuration / 3600);
const totalMinutes = Math.floor((globalTotalDuration % 3600) / 60);
const totalTimeStr = `${totalHours}u ${totalMinutes}m`;

// Helper: Group by Date (YYYY-MM-DD)
const groupByDate = (data: any[]) => {
  const grouped = data.reduce((acc, curr) => {
    const date = new Date(curr.timestamp).toISOString().split('T')[0];
    acc[date] = (acc[date] || 0) + 1;
    return acc;
  }, {});
  return grouped;
};

// Helper: Group by Field
const groupByField = (data: any[], field: string) => {
    return data.reduce((acc, curr) => {
        const val = curr[field] || 'Unknown';
        acc[val] = (acc[val] || 0) + 1;
        return acc;
    }, {});
}

// 1. Views & Clicks Over Time (Last 7 Days)
const viewsByDate = groupByDate(views);
const clicksByDate = groupByDate(clicks);

// Unique Views by Date
const uniqueViewsByDate = views.reduce((acc, curr) => {
    const date = new Date(curr.timestamp).toISOString().split('T')[0];
    if (!acc[date]) acc[date] = new Set();
    acc[date].add(curr.visitorId || curr.userAgent); // Fallback to UA if no visitorId
    return acc;
}, {});

// Generate last 7 days labels
const labels = [];
const viewData = [];
const uniqueViewData = [];
const clickData = [];
for (let i = 6; i >= 0; i--) {
  const d = new Date();
  d.setDate(d.getDate() - i);
  const dateStr = d.toISOString().split('T')[0];
  labels.push(d.toLocaleDateString('nl-NL', { weekday: 'short', day: 'numeric' }));
  viewData.push(viewsByDate[dateStr] || 0);
  clickData.push(clicksByDate[dateStr] || 0);
  uniqueViewData.push(uniqueViewsByDate[dateStr] ? uniqueViewsByDate[dateStr].size : 0);
}

// 2. Top Articles (Views & CTR)
const articleStats = uniquePosts.map(p => {
    const pViews = views.filter(v => v.slug === p.slug);
    const viewCount = pViews.length;
    const pClicks = clicks.filter(c => c.slug === p.slug).length;
    const ctr = viewCount > 0 ? ((pClicks / viewCount) * 100).toFixed(1) : '0.0';
    
    // Calculate Avg Time
    const totalDuration = pViews.reduce((acc, curr) => acc + (curr.duration || 0), 0);
    const avgTime = viewCount > 0 ? Math.round(totalDuration / viewCount) : 0;
    const minutes = Math.floor(avgTime / 60);
    const seconds = avgTime % 60;
    const timeStr = `${minutes}m ${seconds}s`;

    return { title: p.title, views: viewCount, clicks: pClicks, ctr, timeStr };
}).sort((a, b) => b.views - a.views).slice(0, 5);

// 3. Device Breakdown
const deviceData = views.reduce((acc, curr) => {
    const ua = (curr.userAgent || '').toLowerCase();
    if(ua.includes('mobile')) acc.Mobile++;
    else acc.Desktop++;
    return acc;
}, { Desktop: 0, Mobile: 0 });

// 4. Referrers
const referrerData = groupByField(views, 'source');
const topReferrers = Object.entries(referrerData)
    .sort(([,a]:any, [,b]:any) => b - a)
    .slice(0, 5);

// 5. Countries
const countryData = groupByField(views, 'country');
const topCountries = Object.entries(countryData)
    .sort(([,a]:any, [,b]:any) => b - a)
    .slice(0, 10);

const chartData = {
    labels,
    views: viewData,
    uniqueViews: uniqueViewData,
    clicks: clickData,
    device: [deviceData.Desktop, deviceData.Mobile],
    referrerLabels: topReferrers.map(([k]) => k),
    referrerValues: topReferrers.map(([,v]) => v),
    countryLabels: topCountries.map(([k]) => k),
    countryValues: topCountries.map(([,v]) => v)
};
---

<DashboardLayout title="Uitgebreide Analytics" activePage="analytics">
  
  <!-- Hero Stats Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Views (Flip Counter) -->
    <div class="col-span-1 md:col-span-2">
       <FlipCounter id="analytics-total-views" label="TOTAL VIEWS" initialValue={totalSiteViews} />
    </div>

    <!-- Total Clicks -->
    <div class="glass p-6 rounded-2xl relative overflow-hidden group bg-gradient-to-br from-white/10 to-green-50/5 hover:border-green-200 transition-colors">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
        </svg>
      </div>
      <p class="text-xs text-muted uppercase tracking-wide mb-1 font-semibold">Totaal Clicks</p>
      <p class="text-3xl font-bold text-emerald-600" id="total-clicks">{totalSiteClicks}</p>
    </div>

    <!-- Time Stats -->
    <div class="glass p-6 rounded-2xl relative overflow-hidden group bg-gradient-to-br from-white/10 to-purple-50/5 hover:border-purple-200 transition-colors">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="space-y-4">
          <div>
            <p class="text-xs text-muted uppercase tracking-wide mb-1 font-semibold">Gem. Leestijd</p>
            <p class="text-2xl font-bold text-purple-600" id="avg-time">{globalMinutes}m {globalSeconds}s</p>
          </div>
          <div class="pt-3 border-t border-dashed border-purple-100">
             <p class="text-[10px] text-muted uppercase tracking-wide mb-0.5 font-semibold">Totale Tijd</p>
             <p class="text-lg font-bold text-purple-400" id="total-time">{totalTimeStr}</p>
          </div>
      </div>
    </div>
  </div>

  <!-- Charts Row 1: Timeline & Devices -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Main Chart: Views vs Clicks -->
    <div class="glass p-6 rounded-2xl lg:col-span-2">
        <h3 class="text-navy font-bold mb-4">Traffic Overview (Laatste 7 Dagen)</h3>
        <div class="relative h-64 w-full">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <!-- Device Donut -->
    <div class="glass p-6 rounded-2xl">
        <h3 class="text-navy font-bold mb-4">Apparaten</h3>
         <div class="relative h-48 w-full flex justify-center">
            <canvas id="deviceChart"></canvas>
        </div>
        <div class="mt-4 flex justify-center gap-4 text-sm">
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span> Desktop
            </div>
            <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span> Mobile
            </div>
        </div>
    </div>
  </div>

  <!-- Row 2: Top Articles & Countries -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      
      <!-- Top Articles Table -->
      <div class="glass p-6 rounded-2xl overflow-hidden lg:col-span-2">
          <h3 class="text-navy font-bold mb-4">Top Artikelen</h3>
          <table class="w-full text-sm">
              <thead class="bg-navy/5 text-navy font-semibold">
                  <tr>
                      <th class="px-3 py-2 text-left">Artikel</th>
                      <th class="px-3 py-2 text-right">Views</th>
                      <th class="px-3 py-2 text-right">Gem. Tijd</th>
                      <th class="px-3 py-2 text-right">Clicks</th>
                      <th class="px-3 py-2 text-right">CTR</th>
                  </tr>
              </thead>
              <tbody class="divide-y divide-navy/5">
                {articleStats.map((stat, i) => (
                    <tr class="hover:bg-navy/5">
                        <td class="px-3 py-2 truncate max-w-[150px] font-medium" title={stat.title}>
                            {i+1}. {stat.title}
                        </td>
                        <td class="px-3 py-2 text-right opacity-80">{stat.views}</td>
                        <td class="px-3 py-2 text-right text-muted font-mono text-xs">{stat.timeStr}</td>
                        <td class="px-3 py-2 text-right text-green-600 font-medium">{stat.clicks}</td>
                        <td class="px-3 py-2 text-right text-muted">{stat.ctr}%</td>
                    </tr>
                ))}
                {articleStats.length === 0 && (
                    <tr><td colspan="5" class="p-4 text-center text-muted">Geen data beschikbaar</td></tr>
                )}
              </tbody>
          </table>
      </div>

     <!-- Countries List -->
      <div class="glass p-6 rounded-2xl">
        <h3 class="text-navy font-bold mb-4">Top Landen</h3>
        <div class="space-y-3 country-list-container">
             {topCountries.map(([country, count], i) => (
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-muted w-4">{i+1}.</span>
                        <span class="font-medium text-navy">{country === 'Unknown' ? 'Onbekend' : country}</span>
                    </div>
                    <span class="bg-navy/5 px-2 py-0.5 rounded-full text-xs font-semibold text-navy">{count as number}</span>
                </div>
            ))}
             {topCountries.length === 0 && (
                <p class="text-muted text-sm italic">Geen land info beschikbaar</p>
            )}
        </div>
    </div>

  </div>

  <!-- Row 3: Referrers -->
  <div class="grid grid-cols-1 mb-6">
      <div class="glass p-6 rounded-2xl">
        <h3 class="text-navy font-bold mb-4">Top Verwijzers</h3>
        <div class="relative h-64 w-full">
            <canvas id="referrerChart"></canvas>
        </div>
    </div>
  </div>

  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script is:inline define:vars={{ chartData }}>
    // Chart Options: No decimals
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } },
        scales: {
             y: { 
                 beginAtZero: true, 
                 grid: { color: 'rgba(0,0,0,0.05)' },
                 ticks: { stepSize: 1, precision: 0 } // No decimals
             },
             x: { grid: { display: false } }
        }
    };

    // 1. Line Chart (Views, Unique Views, Clicks)
    const mainChart = new Chart(document.getElementById('mainChart'), {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [
          {
            label: 'Totaal Views',
            data: chartData.views,
            borderColor: '#3B82F6', // Blue
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          },
          {
            label: 'Unieke Views',
            data: chartData.uniqueViews,
            borderColor: '#8B5CF6', // Purple
            backgroundColor: 'rgba(139, 92, 246, 0.05)',
            borderDash: [5, 5],
            tension: 0.4,
            fill: false
          },
          {
            label: 'Clicks',
            data: chartData.clicks,
            borderColor: '#10B981', // Green
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: commonOptions
    });

    // 2. Device Doughnut
    const deviceChart = new Chart(document.getElementById('deviceChart'), {
      type: 'doughnut',
      data: {
        labels: ['Desktop', 'Mobile'],
        datasets: [{
          data: chartData.device,
          backgroundColor: ['#3B82F6', '#F97316'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        cutout: '70%'
      }
    });

    // 3. Referrer Bar
    const referrerChart = new Chart(document.getElementById('referrerChart'), {
      type: 'bar',
      data: {
        labels: chartData.referrerLabels,
        datasets: [{
          label: 'Bezoekers',
          data: chartData.referrerValues,
          backgroundColor: '#8B5CF6',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } },
         scales: {
             x: { 
                 beginAtZero: true, 
                 grid: { color: 'rgba(0,0,0,0.05)' },
                 ticks: { stepSize: 1, precision: 0 } 
             },
             y: { grid: { display: false } }
        }
      }
    });

    // --- Real-time Updates ---
    async function updateCharts() {
        try {
            const res = await fetch('/api/analytics/stats');
            const data = await res.json();
            if(data.error) return;

            // 1. Update Main Chart
            mainChart.data.labels = data.chartData.labels;
            mainChart.data.datasets[0].data = data.chartData.views;
            mainChart.data.datasets[1].data = data.chartData.uniqueViews;
            mainChart.data.datasets[2].data = data.chartData.clicks;
            mainChart.update('none'); 

            // 2. Update Device Chart
            deviceChart.data.datasets[0].data = data.chartData.device;
            deviceChart.update('none');

            // 3. Update Referrer Chart
            referrerChart.data.labels = data.chartData.referrerLabels;
            referrerChart.data.datasets[0].data = data.chartData.referrerValues;
            referrerChart.update('none');

             // 4. Update Stats Cards (New)
            const elClicks = document.getElementById('total-clicks');
            if(elClicks) elClicks.innerText = data.totalClicks;

            const elAvgTime = document.getElementById('avg-time');
            if(elAvgTime) elAvgTime.innerText = data.avgTimeStr;

            const elTotalTime = document.getElementById('total-time');
            if(elTotalTime) elTotalTime.innerText = data.totalTimeStr;

            // 5. Dispatch FlipCounter Update
            document.dispatchEvent(new CustomEvent('analytics-update', { 
                detail: { totalViews: data.totalViews } 
            }));

            // 6. Update Countries List (DOM)
            const countryList = document.querySelector('.country-list-container');
            if(countryList && data.topCountries) {
                let html = '';
                data.topCountries.forEach(([country, count], i) => {
                     html += `
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-muted w-4">${i+1}.</span>
                                <span class="font-medium text-navy">${country}</span>
                            </div>
                            <span class="bg-navy/5 px-2 py-0.5 rounded-full text-xs font-semibold text-navy">${count}</span>
                        </div>
                     `;
                });
                if(data.topCountries.length === 0) html = '<p class="text-muted text-sm italic">Geen land info beschikbaar</p>';
                countryList.innerHTML = html;
            }

        } catch(e) {
            // console.error(e);
        }
    }

    setInterval(updateCharts, 5000);
    updateCharts(); // Run immediately on load

  </script>

</DashboardLayout>
