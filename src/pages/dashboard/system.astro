---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { query } from '../../lib/db/postgres.ts';

interface SystemConfig {
  id: number;
  system_paused: boolean;
  auto_publish_enabled: boolean;
  max_articles_per_week: number;
  enable_multi_agent: boolean;
  enable_auto_evolution: boolean;
}

// Fetch system config
let config: SystemConfig | null = null;
let configError = '';

try {
  const rows = await query<SystemConfig>('SELECT * FROM system_config WHERE id = 1 LIMIT 1');
  config = rows[0] ?? null;
} catch (err) {
  configError = err instanceof Error ? err.message : 'Database niet beschikbaar';
}

// Fetch pending evolution suggestions
let evolutionSuggestions: any[] = [];
try {
  evolutionSuggestions = await query(
    `SELECT al.*, ag.name as agent_name, ag.role as agent_role
     FROM agent_logs al
     LEFT JOIN agents ag ON al.agent_id = ag.id
     WHERE al.stage = 'evolution:suggestion'
     ORDER BY al.created_at DESC
     LIMIT 20`
  );
} catch {
  // Silently ignore if tables don't exist yet
}
---

<DashboardLayout title="Systeem Configuratie" activePage="system">
  <div class="space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-bold text-navy">Systeem Configuratie</h2>
        <p class="text-sm text-gray-500 mt-1">Beheer de AI editorial engine instellingen en schakelknoppen.</p>
      </div>
      {config && (
        <span class={`text-xs font-semibold px-3 py-1 rounded-full ${config.system_paused ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
          {config.system_paused ? 'GEPAUZEERD' : 'ACTIEF'}
        </span>
      )}
    </div>

    {configError && (
      <div class="glass rounded-xl p-4 border border-red-200">
        <p class="text-sm text-red-600">
          <strong>Database fout:</strong> {configError}
        </p>
        <p class="text-xs text-gray-500 mt-1">Voer eerst <code class="bg-gray-100 px-1 rounded">POST /api/admin/migrate</code> uit.</p>
      </div>
    )}

    {config && (
      <>
        <!-- Deployment Checklist -->
        <div class="glass rounded-xl border border-white/20 p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-sm font-semibold text-navy">Deployment Checklist</h3>
              <p class="text-xs text-gray-500 mt-0.5">Taken die na elke deployment uitgevoerd moeten worden.</p>
            </div>
            <button id="refresh-deploy-btn" class="text-xs text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Vernieuwen
            </button>
          </div>
          <div id="deploy-checklist" class="space-y-3">
            <div class="text-xs text-gray-400 animate-pulse">Status laden...</div>
          </div>
        </div>

        <!-- System Controls -->
        <div class="glass rounded-xl border border-white/20 p-6">
          <h3 class="text-sm font-semibold text-navy mb-4">Schakelknoppen</h3>

          <div class="space-y-4" id="config-form">
            <!-- System Paused -->
            <div class="flex items-center justify-between py-3 border-b border-white/10">
              <div>
                <p class="text-sm font-medium text-gray-800">Systeem pauzeren</p>
                <p class="text-xs text-gray-500">Stopt alle nieuwe redactionele cycli direct.</p>
              </div>
              <label class="relative inline-flex cursor-pointer items-center">
                <input type="checkbox" class="config-toggle sr-only" data-key="system_paused"
                       checked={config.system_paused} />
                <div class="toggle-track h-6 w-11 rounded-full bg-gray-200 transition-colors peer-checked:bg-red-500"></div>
                <div class="toggle-dot absolute left-1 top-1 h-4 w-4 rounded-full bg-white shadow transition-transform"></div>
              </label>
            </div>

            <!-- Auto Publish -->
            <div class="flex items-center justify-between py-3 border-b border-white/10">
              <div>
                <p class="text-sm font-medium text-gray-800">Automatisch publiceren</p>
                <p class="text-xs text-gray-500">Publiceert goedgekeurde artikelen direct naar de blog.</p>
              </div>
              <label class="relative inline-flex cursor-pointer items-center">
                <input type="checkbox" class="config-toggle sr-only" data-key="auto_publish_enabled"
                       checked={config.auto_publish_enabled} />
                <div class="toggle-track h-6 w-11 rounded-full bg-gray-200 transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 h-4 w-4 rounded-full bg-white shadow transition-transform"></div>
              </label>
            </div>

            <!-- Multi-Agent -->
            <div class="flex items-center justify-between py-3 border-b border-white/10">
              <div>
                <p class="text-sm font-medium text-gray-800">Multi-agent modus</p>
                <p class="text-xs text-gray-500">Schakelt het volledige Analyst→SEO pipeline in.</p>
              </div>
              <label class="relative inline-flex cursor-pointer items-center">
                <input type="checkbox" class="config-toggle sr-only" data-key="enable_multi_agent"
                       checked={config.enable_multi_agent} />
                <div class="toggle-track h-6 w-11 rounded-full bg-gray-200 transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 h-4 w-4 rounded-full bg-white shadow transition-transform"></div>
              </label>
            </div>

            <!-- Auto Evolution -->
            <div class="flex items-center justify-between py-3 border-b border-white/10">
              <div>
                <p class="text-sm font-medium text-gray-800">Auto-evolutie</p>
                <p class="text-xs text-gray-500">Analyst-suggesties worden automatisch toegepast (geen goedkeuring vereist).</p>
              </div>
              <label class="relative inline-flex cursor-pointer items-center">
                <input type="checkbox" class="config-toggle sr-only" data-key="enable_auto_evolution"
                       checked={config.enable_auto_evolution} />
                <div class="toggle-track h-6 w-11 rounded-full bg-gray-200 transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 h-4 w-4 rounded-full bg-white shadow transition-transform"></div>
              </label>
            </div>

            <!-- Max articles per week -->
            <div class="flex items-center justify-between py-3">
              <div>
                <p class="text-sm font-medium text-gray-800">Max artikelen per week</p>
                <p class="text-xs text-gray-500">Limiet voor automatische artikel generatie per kalenderweek.</p>
              </div>
              <div class="flex items-center gap-2">
                <input
                  type="number"
                  id="max_articles_input"
                  class="w-16 text-center border border-gray-200 rounded-lg py-1.5 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-navy/30"
                  value={config.max_articles_per_week}
                  min="1"
                  max="20"
                />
                <button id="save-max-btn" class="text-xs bg-navy text-white px-3 py-1.5 rounded-lg hover:bg-navy/90 transition-colors">
                  Opslaan
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Run Cycle -->
        <div class="glass rounded-xl border border-white/20 p-6">
          <h3 class="text-sm font-semibold text-navy mb-2">Redactionele Cyclus</h3>
          <p class="text-xs text-gray-500 mb-4">
            Start een volledige AI redactionele cyclus: Analyst → Strateeg → Redacteur → Schrijver → Humanizer → SEO.
            Dit kan 1-3 minuten duren.
          </p>

          <div class="flex items-center gap-3">
            <button id="run-cycle-btn"
              class="inline-flex items-center gap-2 bg-navy text-white text-sm font-semibold py-2.5 px-5 rounded-lg hover:bg-navy/90 transition-all disabled:opacity-50"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              1 Artikel
            </button>

            <button id="run-3cycles-btn"
              class="inline-flex items-center gap-2 bg-purple-600 text-white text-sm font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-700 transition-all disabled:opacity-50"
              title="Voert 3 cycli na elkaar uit (1 artikel per cyclus)"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              3 Artikelen
            </button>
          </div>

          <!-- Progress section (hidden by default) -->
          <div id="cycle-progress" class="mt-4 hidden">
            <!-- Progress bar -->
            <div class="mb-3">
              <div class="flex items-center justify-between mb-1">
                <span id="cycle-stage" class="text-xs font-medium text-navy">Starten...</span>
                <span id="cycle-percent" class="text-xs font-semibold text-navy">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                <div id="cycle-bar" class="h-2.5 rounded-full bg-gradient-to-r from-navy to-blue-500 transition-all duration-500 ease-out" style="width: 0%"></div>
              </div>
            </div>

            <!-- Live log feed -->
            <div id="cycle-log" class="bg-gray-900 rounded-lg p-3 text-xs font-mono text-green-400 max-h-48 overflow-y-auto space-y-0.5"></div>
          </div>

          <!-- Final result (shown after completion) -->
          <div id="cycle-result" class="mt-4 hidden">
            <div id="cycle-output" class="glass rounded-lg p-4 border border-white/10 text-xs font-mono text-gray-700 whitespace-pre-wrap max-h-64 overflow-auto"></div>
          </div>
        </div>
      </>
    )}

    <!-- Evolution Suggestions Queue -->
    {evolutionSuggestions.length > 0 && (
      <div class="glass rounded-xl border border-white/20 p-6">
        <h3 class="text-sm font-semibold text-navy mb-4">Evolutie Suggesties</h3>
        <p class="text-xs text-gray-500 mb-4">
          De Analyst heeft gedragsaanpassingen voorgesteld voor onderstaande agents.
          {config?.enable_auto_evolution ? 'Auto-evolutie staat aan — worden automatisch toegepast.' : 'Keur handmatig goed of wijs af.'}
        </p>
        <div class="space-y-3">
          {evolutionSuggestions.map((s) => (
            <div class="flex items-start gap-3 p-3 bg-amber-50/50 rounded-lg border border-amber-200/50">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold text-amber-800">{s.agent_name ?? 'Onbekend'}</span>
                  <span class="text-xs text-gray-400">({s.agent_role})</span>
                </div>
                <p class="text-xs text-gray-600">{s.reasoning_summary}</p>
                {s.decision_summary && (
                  <pre class="text-xs text-gray-500 mt-1 bg-white/60 rounded p-1 overflow-auto max-h-20">
                    {typeof s.decision_summary === 'string' ? s.decision_summary : JSON.stringify(s.decision_summary, null, 2)}
                  </pre>
                )}
              </div>
              {!config?.enable_auto_evolution && s.agent_id && (
                <button
                  class="apply-evolution-btn shrink-0 text-xs bg-navy text-white px-3 py-1.5 rounded-lg hover:bg-navy/90"
                  data-agent-id={s.agent_id}
                  data-log-id={s.id}
                  data-overrides={JSON.stringify(s.decision_summary?.suggested_overrides ?? {})}
                >
                  Toepassen
                </button>
              )}
            </div>
          ))}
        </div>
      </div>
    )}

  </div>
</DashboardLayout>

<style>
  .config-toggle:checked + .toggle-track {
    background-color: rgb(27 45 79);
  }
  .config-toggle:checked ~ .toggle-dot {
    transform: translateX(20px);
  }
  .toggle-track {
    position: relative;
  }
  .toggle-dot {
    position: absolute;
  }
  label {
    position: relative;
  }
</style>

<script>
  // Toggle switches — save immediately on change
  document.querySelectorAll<HTMLInputElement>('.config-toggle').forEach((toggle) => {
    // Sync initial visual state
    const track = toggle.nextElementSibling as HTMLElement;
    const dot = track?.nextElementSibling as HTMLElement;
    if (toggle.checked) {
      track?.classList.add('!bg-navy');
      dot?.style.setProperty('transform', 'translateX(20px)');
    }

    toggle.addEventListener('change', async () => {
      const key = toggle.dataset.key;
      const value = toggle.checked;
      if (!key) return;

      // Update visual
      const t = toggle.nextElementSibling as HTMLElement;
      const d = t?.nextElementSibling as HTMLElement;
      if (value) {
        t?.classList.add('!bg-navy');
        d?.style.setProperty('transform', 'translateX(20px)');
      } else {
        t?.classList.remove('!bg-navy');
        d?.style.setProperty('transform', 'translateX(0px)');
      }

      try {
        await fetch('/api/admin/system', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: value }),
        });
      } catch (err) {
        console.error('Failed to save config:', err);
        toggle.checked = !value; // Revert on failure
      }
    });
  });

  // Max articles per week save button
  document.getElementById('save-max-btn')?.addEventListener('click', async () => {
    const input = document.getElementById('max_articles_input') as HTMLInputElement;
    const value = parseInt(input.value);
    if (isNaN(value) || value < 1) return;

    await fetch('/api/admin/system', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ max_articles_per_week: value }),
    });
  });

  // ── Run cycle with SSE progress streaming ──────────────────────────────────

  const STAGE_LABELS: Record<string, string> = {
    init: 'Configuratie',
    analyst: 'Markt-Analist',
    strategist: 'Strateeg',
    editor: 'Redacteur',
    writer: 'Schrijver',
    humanizer: 'Humanizer',
    seo: 'SEO Optimizer',
    embedding: 'Opslaan',
    done: 'Voltooid',
    error: 'Fout',
  };

  function formatTime(date: Date): string {
    return date.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function appendLog(message: string, type: 'info' | 'error' | 'success' = 'info') {
    const logDiv = document.getElementById('cycle-log');
    if (!logDiv) return;
    const line = document.createElement('div');
    const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-emerald-400' : 'text-green-400';
    line.className = colorClass;
    line.textContent = `[${formatTime(new Date())}] ${message}`;
    logDiv.appendChild(line);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function updateProgress(progress: number, stage: string) {
    const bar = document.getElementById('cycle-bar') as HTMLElement;
    const percent = document.getElementById('cycle-percent');
    const stageEl = document.getElementById('cycle-stage');
    if (bar) bar.style.width = `${progress}%`;
    if (percent) percent.textContent = `${progress}%`;
    if (stageEl) stageEl.textContent = STAGE_LABELS[stage] ?? stage;
  }

  function resetCycleUI() {
    const btn = document.getElementById('run-cycle-btn') as HTMLButtonElement;
    if (btn) { btn.disabled = false; btn.textContent = 'Cyclus Uitvoeren'; }
    sessionStorage.removeItem('cycle_running');
  }

  document.getElementById('run-cycle-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('run-cycle-btn') as HTMLButtonElement;
    const progressDiv = document.getElementById('cycle-progress');
    const resultDiv = document.getElementById('cycle-result');
    const outputDiv = document.getElementById('cycle-output');
    const logDiv = document.getElementById('cycle-log');

    btn.disabled = true;
    btn.textContent = 'Bezig...';
    progressDiv?.classList.remove('hidden');
    resultDiv?.classList.add('hidden');
    if (logDiv) logDiv.innerHTML = '';
    if (outputDiv) outputDiv.textContent = '';
    updateProgress(0, 'init');
    appendLog('Cyclus gestart...');

    sessionStorage.setItem('cycle_running', Date.now().toString());

    try {
      const response = await fetch('/api/admin/run-cycle', {
        method: 'POST',
        headers: { 'Accept': 'text/event-stream' },
      });

      if (!response.ok || !response.body) {
        const text = await response.text();
        appendLog(`HTTP fout: ${response.status} ${text}`, 'error');
        resetCycleUI();
        return;
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() ?? '';

        let currentEvent = '';
        for (const line of lines) {
          if (line.startsWith('event: ')) {
            currentEvent = line.slice(7).trim();
          } else if (line.startsWith('data: ')) {
            const raw = line.slice(6);
            try {
              const data = JSON.parse(raw);

              if (currentEvent === 'progress') {
                updateProgress(data.progress, data.stage);
                const logType = data.stage === 'error' ? 'error' as const : 'info' as const;
                appendLog(data.message, logType);
              } else if (currentEvent === 'done') {
                updateProgress(100, 'done');
                appendLog(data.summary
                  ? `Voltooid: ${data.summary.articles_produced} artikel(en) in ${Math.round(data.duration_ms / 1000)}s`
                  : 'Cyclus voltooid.', 'success');
                resultDiv?.classList.remove('hidden');
                if (outputDiv) outputDiv.textContent = JSON.stringify(data, null, 2);
                resetCycleUI();
              } else if (currentEvent === 'error') {
                updateProgress(100, 'error');
                appendLog(`Fout: ${data.error}`, 'error');
                resetCycleUI();
              }
            } catch { /* ignore malformed JSON */ }
            currentEvent = '';
          }
        }
      }

      // If stream ended without done/error event, reset UI
      resetCycleUI();

    } catch (err) {
      appendLog(`Netwerkfout: ${err}`, 'error');
      resetCycleUI();
    }
  });

  // ── 3-Cycle Button: runs 3 sequential cycles, 1 article each ─────────────
  document.getElementById('run-3cycles-btn')?.addEventListener('click', async () => {
    const btn3 = document.getElementById('run-3cycles-btn') as HTMLButtonElement;
    const btn1 = document.getElementById('run-cycle-btn') as HTMLButtonElement;
    if (btn3.disabled) return;

    btn3.disabled = true;
    btn1.disabled = true;
    btn3.textContent = 'Bezig...';

    const progressDiv = document.getElementById('cycle-progress');
    progressDiv?.classList.remove('hidden');
    clearLog();

    const totalCycles = 3;
    let articlesProduced = 0;

    for (let i = 1; i <= totalCycles; i++) {
      appendLog(`── Cyclus ${i}/${totalCycles} gestart ──`);
      updateProgress(Math.round(((i - 1) / totalCycles) * 100), 'running');
      btn3.textContent = `Cyclus ${i}/${totalCycles}...`;

      try {
        const response = await fetch('/api/admin/run-cycle', {
          method: 'POST',
          headers: { 'Accept': 'text/event-stream' },
          credentials: 'include',
        });

        if (!response.ok || !response.body) {
          appendLog(`Cyclus ${i} mislukt: HTTP ${response.status}`, 'error');
          continue;
        }

        // Read SSE stream to completion — same pattern as the 1-article button
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let sseEvent = '';    // tracks the current `event:` name
        let cycleArticles = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() ?? '';

          for (const line of lines) {
            if (line.startsWith('event: ')) {
              sseEvent = line.slice(7).trim();
            } else if (line.startsWith('data: ')) {
              const raw = line.slice(6);
              try {
                const data = JSON.parse(raw);
                if (sseEvent === 'progress') {
                  updateProgress(
                    Math.round(((i - 1) / totalCycles) * 100 + (data.progress ?? 0) / totalCycles),
                    data.stage
                  );
                  appendLog(`[${i}] ${data.message}`);
                } else if (sseEvent === 'done') {
                  cycleArticles = data.summary?.articles_produced ?? 0;
                  articlesProduced += cycleArticles;
                  appendLog(`[${i}] Voltooid: ${cycleArticles} artikel(en)`, cycleArticles > 0 ? 'success' : undefined);
                } else if (sseEvent === 'error') {
                  appendLog(`[${i}] Fout: ${data.error}`, 'error');
                }
              } catch { /* ignore malformed JSON */ }
              sseEvent = '';
            }
          }
        }

      } catch (err) {
        appendLog(`Cyclus ${i} netwerkfout: ${err}`, 'error');
      }

      // Brief pause between cycles to let DB writes settle
      if (i < totalCycles) await new Promise(r => setTimeout(r, 2000));
    }

    updateProgress(100, articlesProduced > 0 ? 'success' : 'error');
    appendLog(`── Klaar: ${articlesProduced}/${totalCycles} artikel(en) geproduceerd ──`, articlesProduced > 0 ? 'success' : undefined);

    btn3.disabled = false;
    btn1.disabled = false;
    btn3.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> 3 Artikelen`;
  });

  // Restore cycle-running state if user navigated away and came back
  if (sessionStorage.getItem('cycle_running')) {
    const btn = document.getElementById('run-cycle-btn') as HTMLButtonElement;
    const progressDiv = document.getElementById('cycle-progress');
    if (btn) { btn.disabled = true; btn.textContent = 'Bezig...'; }
    progressDiv?.classList.remove('hidden');
    appendLog('Cyclus loopt nog (pagina herladen — updates niet meer zichtbaar).');
  }

  // ── Deployment Checklist ──────────────────────────────────────────────────
  async function loadDeployStatus() {
    const container = document.getElementById('deploy-checklist');
    if (!container) return;

    try {
      const res = await fetch('/api/admin/deployment-status');
      const data = await res.json();

      if (!res.ok || !data.checks?.length) {
        container.innerHTML = `<p class="text-xs text-red-500">Fout bij laden: ${data.error ?? res.statusText}</p>`;
        return;
      }

      const allDone = data.checks.every((c: any) => c.ok);

      container.innerHTML = data.checks.map((check: any) => `
        <div class="flex items-center justify-between gap-3 py-2.5 border-b border-white/10 last:border-0">
          <div class="flex items-center gap-3 min-w-0">
            <span class="shrink-0 flex items-center justify-center w-6 h-6 rounded-full ${check.ok ? 'bg-green-100' : 'bg-amber-100'}">
              ${check.ok
                ? `<svg class="w-3.5 h-3.5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>`
                : `<svg class="w-3.5 h-3.5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>`
              }
            </span>
            <div class="min-w-0">
              <p class="text-sm font-medium ${check.ok ? 'text-gray-700' : 'text-gray-900'}">${check.label}</p>
              <p class="text-xs text-gray-500 truncate">${check.description}</p>
            </div>
          </div>
          ${!check.ok
            ? `<button
                class="deploy-action-btn shrink-0 text-xs bg-navy text-white px-3 py-1.5 rounded-lg hover:bg-navy/90 transition-colors whitespace-nowrap"
                data-method="${check.action.method}"
                data-url="${check.action.url}"
                data-id="${check.id}"
              >${check.actionLabel}</button>`
            : `<span class="shrink-0 text-xs text-green-600 font-medium">Klaar</span>`
          }
        </div>
      `).join('') + (allDone
        ? `<p class="text-xs text-green-700 bg-green-50 rounded-lg px-3 py-2 mt-2">✓ Alles up-to-date na de laatste deployment.</p>`
        : `<p class="text-xs text-amber-700 bg-amber-50 rounded-lg px-3 py-2 mt-2">Voer de openstaande taken uit voor een correcte werking.</p>`
      );

      // Attach button handlers
      container.querySelectorAll<HTMLButtonElement>('.deploy-action-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.textContent = 'Bezig...';
          try {
            const resp = await fetch(btn.dataset.url!, { method: btn.dataset.method!, credentials: 'include' });
            const result = await resp.json();
            if (!resp.ok) throw new Error(result.error ?? resp.statusText);
            // Refresh the checklist to show updated status
            await loadDeployStatus();
          } catch (err) {
            btn.disabled = false;
            btn.textContent = btn.dataset.id === 'metricsSync' ? 'Sync Nu' : 'Migreer Nu';
            alert(`Actie mislukt: ${err}`);
          }
        });
      });

    } catch (err) {
      container.innerHTML = `<p class="text-xs text-red-500">Netwerk fout: ${err}</p>`;
    }
  }

  loadDeployStatus();
  document.getElementById('refresh-deploy-btn')?.addEventListener('click', loadDeployStatus);

  // Apply evolution suggestions
  document.querySelectorAll<HTMLButtonElement>('.apply-evolution-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const agentId = btn.dataset.agentId;
      const logId = btn.dataset.logId;
      let overrides: Record<string, unknown>;
      try {
        overrides = JSON.parse(btn.dataset.overrides ?? '{}');
      } catch {
        alert('Ongeldig JSON in suggesties. Controleer de agent logs.');
        return;
      }

      // Strip null values — only send overrides that actually have a value
      const cleanOverrides = Object.fromEntries(
        Object.entries(overrides).filter(([, v]) => v !== null)
      );

      btn.disabled = true;
      btn.textContent = 'Toepassen...';

      try {
        // 1. Apply overrides to the agent
        const res = await fetch(`/api/admin/agents/${agentId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ behavior_overrides: cleanOverrides }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          alert(`Fout bij toepassen: ${err.error ?? res.statusText}`);
          btn.textContent = 'Toepassen';
          btn.disabled = false;
          return;
        }

        // 2. Mark the log as applied so it doesn't reappear
        if (logId) {
          await fetch('/api/admin/logs', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: logId, stage: 'evolution:applied' }),
          });
        }

        // 3. Fade out and remove the suggestion card
        const card = btn.closest('.flex.items-start') as HTMLElement;
        if (card) {
          card.style.transition = 'opacity 0.3s, max-height 0.3s';
          card.style.opacity = '0';
          card.style.maxHeight = card.scrollHeight + 'px';
          setTimeout(() => {
            card.style.maxHeight = '0';
            card.style.overflow = 'hidden';
            card.style.padding = '0';
            card.style.margin = '0';
            card.style.border = 'none';
          }, 300);
          setTimeout(() => card.remove(), 600);
        }
      } catch (err) {
        alert(`Netwerkfout: ${err}`);
        btn.textContent = 'Toepassen';
        btn.disabled = false;
      }
    });
  });
</script>
