---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { platforms } from '../../data/platforms';
import { articleTemplates } from '../../data/templates';
---

<DashboardLayout title="Nieuw Artikel" activePage="new">

  <div id="wizard-app" class="max-w-5xl mx-auto space-y-8 pb-20">
    
    <!-- Step Indicator -->
    <div class="flex items-center justify-between px-4 py-4 bg-gray-900 rounded-xl border border-gray-800">
      <div class="flex items-center gap-4">
        {[1, 2, 3, 4].map((step) => (
          <div class="flex items-center gap-2 step-indicator" data-step={step}>
            <div class={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-colors duration-300 step-circle border-gray-700 text-gray-400 bg-gray-900`}>
              {step}
            </div>
            <span class="text-sm font-medium hidden sm:block text-gray-400 step-label">
              {step === 1 && 'Setup'}
              {step === 2 && 'Outline'}
              {step === 3 && 'Schrijven'}
              {step === 4 && 'Review'}
            </span>
            {step < 4 && <div class="w-8 h-0.5 bg-gray-800 mx-2 hidden sm:block"></div>}
          </div>
        ))}
      </div>
      <div>
        <button id="save-draft-btn" class="text-sm text-gray-400 hover:text-white transition-colors">
          Opslaan als concept
        </button>
      </div>
    </div>

    <!-- Step 1: Configuration -->
    <section id="step-1" class="wizard-step">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 sm:p-8">
        <h2 class="text-xl font-bold text-white mb-6">Artikel Configuratie</h2>
        
        <div class="grid gap-6 md:grid-cols-2">
          <!-- Keyword -->
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-400 mb-2">Target Keyword</label>
            <input type="text" id="target_keyword" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none" placeholder="bv. BitMEX vs Bybit review" />
          </div>

          <!-- Article Type -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Artikel Type</label>
            <select id="article_type" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none">
              <option value="">Automatisch bepalen (aanbevolen)</option>
              {articleTemplates.map(t => (
                <option value={t.intent}>{t.label}</option>
              ))}
            </select>
          </div>

          <!-- Monetization -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Monetisatie Focus</label>
            <select id="monetization_priority" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none">
              <option value="revenue_share">Revenue Share (Lange termijn)</option>
              <option value="cpa">CPA (Directe vergoeding)</option>
            </select>
          </div>

          <!-- Platforms -->
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-400 mb-3">Welke platformen bespreken?</label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
              {platforms.map(p => (
                <label class="relative flex items-center justify-center p-4 rounded-lg border border-gray-700 bg-gray-950 cursor-pointer hover:border-gray-500 transition-all group has-[:checked]:border-yellow-500 has-[:checked]:bg-yellow-500/10">
                  <input type="checkbox" name="platforms" value={p.id} class="absolute opacity-0 w-full h-full cursor-pointer" />
                  <span class="font-semibold text-gray-300 group-hover:text-white has-[:checked]:text-yellow-500">{p.name}</span>
                </label>
              ))}
            </div>
          </div>

          <!-- Tone -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Toon & Stijl</label>
            <select id="tone" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none">
              <option value="neutral">Objectief & Informatief</option>
              <option value="opinionated">Persoonlijk & Opiniërend</option>
              <option value="direct">Direct & No-nonsense</option>
            </select>
          </div>

          <!-- FAQ toggle -->
          <div class="flex items-center pt-8">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="include_faq" checked class="w-5 h-5 rounded border-gray-700 bg-gray-950 text-yellow-500 focus:ring-yellow-500/50" />
              <span class="text-gray-300">Genereer FAQ sectie?</span>
            </label>
          </div>
        </div>

        <div class="mt-8 flex justify-end">
          <button id="generate-outline-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-all flex items-center gap-2">
            GENEREER OUTLINE
            <span class="loading-spinner hidden animate-spin">⟳</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Step 2: Outline Editor -->
    <section id="step-2" class="wizard-step hidden">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 sm:p-8">
        <h2 class="text-xl font-bold text-white mb-2">Outline Controleren</h2>
        <p class="text-gray-400 mb-6 text-sm">Controleer de structuur voordat we gaan schrijven. Je kunt secties aanpassen of verwijderen.</p>

        <div class="space-y-6 mb-8">
          <!-- Metadata preview -->
          <div class="grid gap-4 md:grid-cols-2 p-4 bg-gray-950 rounded-lg border border-gray-800">
            <div>
              <label class="text-xs text-gray-500 uppercase">SEO Titel</label>
              <input type="text" id="seo_title" class="w-full bg-transparent text-white font-medium border-none p-0 focus:ring-0" />
            </div>
             <div>
              <label class="text-xs text-gray-500 uppercase">Slug</label>
              <input type="text" id="slug" class="w-full bg-transparent text-gray-400 text-sm border-none p-0 focus:ring-0" />
            </div>
          </div>

          <!-- Sections List -->
          <div id="outline-sections" class="space-y-3">
            <!-- Injected via JS -->
          </div>
        </div>

        <div class="flex justify-between">
           <button class="back-btn text-gray-400 hover:text-white px-6 py-3">Terug</button>
           <button id="start-writing-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-all flex items-center gap-2">
            START MET SCHRIJVEN
             <span class="loading-spinner hidden animate-spin">⟳</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Step 3: Writing Progress -->
    <section id="step-3" class="wizard-step hidden">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-white">Artikel Genereren...</h2>
          <div id="progress-text" class="text-yellow-500 font-mono">0%</div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-800 rounded-full h-2.5 mb-8">
          <div id="progress-bar" class="bg-yellow-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>

        <!-- Live Preview -->
        <div id="live-preview" class="space-y-8 min-h-[400px]">
          <!-- Blocks appear here -->
        </div>

         <div class="mt-8 flex justify-between hidden" id="finish-writing-controls">
           <button class="back-btn text-gray-400 hover:text-white px-6 py-3">Terug</button>
           <button id="to-review-btn" class="bg-green-500 hover:bg-green-400 text-white font-bold py-3 px-8 rounded-lg transition-all">
            NAAR REVIEW
          </button>
        </div>
      </div>
    </section>

     <!-- Step 4: Final Review -->
    <section id="step-4" class="wizard-step hidden">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
        <h2 class="text-xl font-bold text-white mb-6">Klaar voor Publicatie?</h2>
        
        <div class="p-6 bg-gray-950 rounded-xl border border-gray-800 mb-8">
           <h3 class="font-bold text-lg text-white mb-2" id="final-title">...</h3>
           <p class="text-gray-400 mb-4" id="final-description">...</p>
           <div class="flex gap-2 text-xs text-gray-500">
             <span id="final-wordcount">0 woorden</span>
             <span>•</span>
             <span id="final-readingtime">0 min leestijd</span>
           </div>
        </div>

        <div class="flex justify-end gap-4">
           <button id="publish-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-all">
            PUBLICEREN
          </button>
        </div>
      </div>
    </section>

  </div>

  <script>
    // --- State Management ---
    const state = {
      step: 1,
      config: {},
      outline: null,
      generatedBlocks: []
    };

    // --- DOM Elements ---
    const steps = document.querySelectorAll('.wizard-step');
    const stepIndicators = document.querySelectorAll('.step-indicator');
    
    // --- Functions ---
    function setStep(newStep) {
      state.step = newStep;
      
      // Update UI visibility
      steps.forEach(el => el.classList.add('hidden'));
      document.getElementById(`step-${newStep}`).classList.remove('hidden');

      // Update indicators
      stepIndicators.forEach(el => {
        const s = parseInt(el.dataset.step);
        const circle = el.querySelector('.step-circle');
        const label = el.querySelector('.step-label');
        
        if (s === newStep) {
          circle.classList.add('bg-yellow-500', 'text-gray-900', 'border-yellow-500');
          circle.classList.remove('bg-gray-800', 'text-gray-400', 'border-gray-700');
          label.classList.add('text-white');
        } else if (s < newStep) {
           circle.classList.add('bg-green-500', 'text-white', 'border-green-500');
           circle.classList.remove('bg-gray-800', 'text-gray-400', 'border-gray-700', 'bg-yellow-500', 'text-gray-900');
        } else {
           circle.classList.remove('bg-yellow-500', 'text-gray-900', 'border-yellow-500', 'bg-green-500', 'text-white');
           circle.classList.add('bg-gray-800', 'text-gray-400', 'border-gray-700');
           label.classList.remove('text-white');
        }
      });
    }

    // --- Step 1: Generate Outline ---
    document.getElementById('generate-outline-btn').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      const spinner = btn.querySelector('.loading-spinner');
      
      // Collect config
      const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(el => el.value);
      state.config = {
        target_keyword: document.getElementById('target_keyword').value,
        article_type: document.getElementById('article_type').value || undefined,
        monetization_priority: document.getElementById('monetization_priority').value,
        tone: document.getElementById('tone').value,
        include_faq: document.getElementById('include_faq').checked,
        platforms
      };

      if (!state.config.target_keyword) return alert('Vul een keyword in');

      // UI Loading state
      btn.disabled = true;
      spinner.classList.remove('hidden');

      try {
        const res = await fetch('/api/generate/outline', {
          method: 'POST',
          body: JSON.stringify(state.config)
        });
        const data = await res.json();
        
        if (data.error) throw new Error(data.error);

        state.outline = data.outline;
        renderOutline(state.outline);
        setStep(2);

      } catch (err) {
        alert('Fout: ' + err.message);
      } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
      }
    });

    function renderOutline(outline) {
      document.getElementById('seo_title').value = outline.seo_title;
      document.getElementById('slug').value = outline.slug;
      
      const container = document.getElementById('outline-sections');
      container.innerHTML = '';

      outline.sections.forEach((section, idx) => {
        const div = document.createElement('div');
        div.className = 'p-4 bg-gray-950 rounded-lg border border-gray-800 flex gap-4 group';
        div.innerHTML = `
          <div class="text-xs font-mono text-gray-600 pt-1">${idx + 1}</div>
          <div class="flex-1">
            <input class="w-full bg-transparent font-semibold text-gray-200 focus:text-white border-none p-0 focus:ring-0 mb-1" value="${section.heading}" />
            <p class="text-xs text-gray-500">${section.summary}</p>
          </div>
          <div class="text-xs text-gray-600 flex items-center gap-2">
            <span class="bg-gray-900 px-2 py-1 rounded border border-gray-800">${section.block_id}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // --- Step 2: Start Writing ---
    document.getElementById('start-writing-btn').addEventListener('click', async () => {
      setStep(3);
      await generateAllBlocks();
    });

    async function generateAllBlocks() {
      const container = document.getElementById('live-preview');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      
      container.innerHTML = '';
      state.generatedBlocks = [];
      const sections = state.outline.sections;
      const total = sections.length;

      for (let i = 0; i < total; i++) {
        const section = sections[i];
        
        // Create placeholder
        const placeholder = document.createElement('div');
        placeholder.className = 'p-6 bg-gray-900/50 rounded-xl border border-gray-800 animate-pulse';
        placeholder.innerHTML = `<div class="h-4 bg-gray-800 rounded w-1/3 mb-4"></div><div class="space-y-2"><div class="h-3 bg-gray-800 rounded w-full"></div><div class="h-3 bg-gray-800 rounded w-5/6"></div></div>`;
        container.appendChild(placeholder);

        // Scroll to bottom
        window.scrollTo(0, document.body.scrollHeight);

        try {
          // API Call
          const res = await fetch('/api/generate/block', {
             method: 'POST',
             body: JSON.stringify({
               block_id: section.block_id,
               block_label: section.heading,
               block_description: section.summary,
               outline: state.outline,
               platforms: state.config.platforms,
               previous_blocks: state.generatedBlocks.map(b => ({ block_id: b.block_id, content: b.content })), // context
               tone: state.config.tone,
               target_keyword: state.config.target_keyword
             })
          });
          
          const blockData = await res.json();
          
          // Replace placeholder with real content
          placeholder.className = 'article-block prose prose-invert max-w-none p-6 bg-transparent border-b border-gray-800/50 last:border-0';
          placeholder.innerHTML = `
            <h3 class="text-xl font-bold text-white mb-4">${blockData.heading}</h3>
            <div class="whitespace-pre-wrap text-gray-300">${blockData.content}</div>
          `;
          placeholder.classList.remove('animate-pulse');

          state.generatedBlocks.push(blockData);

          // Update progress
          const pct = Math.round(((i + 1) / total) * 100);
          progressBar.style.width = pct + '%';
          progressText.innerText = pct + '%';

        } catch (err) {
          console.error(err);
          placeholder.innerHTML = `<div class="text-red-500">Error generating block: ${err.message}</div>`;
        }
      }

      // Finish
      document.getElementById('finish-writing-controls').classList.remove('hidden');
    }

    // --- Navigation Handlers ---
    document.querySelectorAll('.back-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (state.step > 1) setStep(state.step - 1);
      });
    });

    document.getElementById('to-review-btn').addEventListener('click', () => {
      // Fill review data
      document.getElementById('final-title').innerText = state.outline.title;
      document.getElementById('final-description').innerText = state.outline.meta_description;
       
      const totalWords = state.generatedBlocks.reduce((acc, b) => acc + b.content.split(' ').length, 0);
      document.getElementById('final-wordcount').innerText = totalWords + ' woorden';
      document.getElementById('final-readingtime').innerText = Math.ceil(totalWords / 200) + ' min leestijd';

      setStep(4);
    });

    document.getElementById('save-draft-btn').addEventListener('click', () => {
      alert('Draft saving logic here');
    });

    document.getElementById('publish-btn').addEventListener('click', async () => {
      const btn = document.getElementById('publish-btn');
      btn.disabled = true;
      btn.innerText = 'Bezig met opslaan...';

      try {
        const payload = {
          title: state.outline.title,
          description: state.outline.meta_description,
          slug: state.outline.slug,
          heroImage: 'https://placehold.co/1200x630/111827/EAB308', // Default for now
          pubDate: new Date().toISOString(),
          target_keyword: state.config.target_keyword,
          seo_title: state.outline.seo_title,
          article_type: state.config.article_type,
          blocks: state.generatedBlocks,
          platforms: state.config.platforms
        };

        const res = await fetch('/api/articles', {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        if (res.ok) {
           window.location.href = '/dashboard?success=published';
        } else {
           throw new Error('Save failed');
        }
      } catch (err) {
        alert('Fout bij publiceren: ' + err.message);
        btn.disabled = false;
        btn.innerText = 'PUBLICEREN';
      }
    });

  </script>

  <style>
    /* Wizard specific styles */
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</DashboardLayout>
