---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { articleTemplates } from '../../data/templates';
import { db, Platform, Post, eq } from 'astro:db';

const platforms = await db.select().from(Platform).orderBy(Platform.name);

// Check if we are editing
const slug = Astro.url.searchParams.get('slug');
let existingArticle = null;
let initialConfig = {};
let initialOutline = null;
let initialBlocks = [];

if (slug) {
  const article = await db.select().from(Post).where(eq(Post.slug, slug)).get();
  if (article) {
    existingArticle = article;
    // Map existing data to state format
    initialConfig = {
      target_keyword: article.target_keyword,
      article_type: article.article_type,
      // monetization_priority: article.monetization_priority, // Not in DB schema yet, maybe skip or default
      // tone: article.tone, // Not in DB schema
      platforms: article.platforms,
      image_provider: 'google', // Default or need to store
      image_style: 'futuristic' // Default
    };
    
    // If blocks exist, we can pre-fill
    if (article.blocks) {
       initialBlocks = article.blocks;
    }
  }
}
---

<DashboardLayout title="Nieuw Artikel" activePage="new">

  <div id="wizard-app" class="max-w-5xl mx-auto space-y-8 pb-20">
    
    <!-- Step Indicator -->
    <div class="flex items-center justify-between px-4 py-4 bg-gray-900 rounded-xl border border-gray-800">
      <div class="flex items-center gap-4">
        {[1, 2, 3, 4].map((step) => (
          <div class="flex items-center gap-2 step-indicator" data-step={step}>
            <div class={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-colors duration-300 step-circle border-gray-700 text-gray-400 bg-gray-900`}>
              {step}
            </div>
            <span class="text-sm font-medium hidden sm:block text-gray-400 step-label">
              {step === 1 && 'Setup'}
              {step === 2 && 'Outline'}
              {step === 3 && 'Schrijven'}
              {step === 4 && 'Review'}
            </span>
            {step < 4 && <div class="w-8 h-0.5 bg-gray-800 mx-2 hidden sm:block"></div>}
          </div>
        ))}
      </div>
      <div>
        <button id="save-draft-btn" class="text-sm text-gray-400 hover:text-white transition-colors">
          Opslaan als concept
        </button>
      </div>
    </div>

    <!-- Step 1: Configuration -->
    <section id="step-1" class="wizard-step">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 sm:p-8">
        <h2 class="text-xl font-bold text-white mb-6">Artikel Configuratie</h2>
        
        <div class="grid gap-6 md:grid-cols-2">
          <!-- Keyword -->
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-400 mb-2">Target Keyword</label>
            <input type="text" id="target_keyword" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none" placeholder="bv. BitMEX vs Bybit review" />
          </div>

          <!-- Article Type -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Artikel Type</label>
            <select id="article_type" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none">
              <option value="">Automatisch bepalen (aanbevolen)</option>
              {articleTemplates.map(t => (
                <option value={t.intent}>{t.label}</option>
              ))}
            </select>
          </div>

          <!-- Monetization -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Monetisatie Focus</label>
            <select id="monetization_priority" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none">
              <option value="revenue_share">Revenue Share (Lange termijn)</option>
              <option value="cpa">CPA (Directe vergoeding)</option>
            </select>
          </div>

          <!-- Target Audience -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Doelgroep</label>
            <input type="text" id="target_audience" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none" placeholder="bv. Ervaren crypto traders, beginners..." />
          </div>

          <!-- Article Angle -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Artikel Invalshoek</label>
            <input type="text" id="article_angle" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none" placeholder="bv. Eerlijke vergelijking op basis van fees" />
          </div>

          <!-- Platforms -->
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-400 mb-3">Welke platformen bespreken?</label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="platform-list">
              {platforms.map(p => (
                <div class="relative group" data-platform-id={p.id}>
                  <label class="flex items-center justify-center p-4 rounded-lg border border-gray-700 bg-gray-950 cursor-pointer hover:border-gray-500 transition-all has-[:checked]:border-yellow-500 has-[:checked]:bg-yellow-500/10 min-h-[64px]">
                    <input type="checkbox" name="platforms" value={p.id} class="absolute opacity-0 w-full h-full cursor-pointer" />
                    <span class="font-semibold text-gray-300 has-[:checked]:text-yellow-500 text-center">{p.name}</span>
                  </label>
                  <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button type="button" class="edit-platform-btn p-1 bg-gray-800 rounded hover:text-yellow-500 text-xs" data-platform={JSON.stringify(p)}>‚úé</button>
                    <button type="button" class="delete-platform-btn p-1 bg-gray-800 rounded hover:text-red-500 text-xs" data-id={p.id}>‚úï</button>
                  </div>
                </div>
              ))}
              
              <!-- Add New Button -->
              <button type="button" id="add-platform-btn" class="flex items-center justify-center p-4 rounded-lg border border-dashed border-gray-700 bg-gray-900/50 hover:bg-gray-800 hover:border-yellow-500 hover:text-yellow-500 text-gray-400 transition-all min-h-[64px]">
                <span class="text-2xl font-bold">+</span>
              </button>
            </div>
          </div>

          <!-- Custom Instructions -->
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-400 mb-2">Specifieke AI Instructies (optioneel)</label>
            <textarea id="custom_instructions" rows="3" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none" placeholder="bv. Focus extra op de veiligheidsaspecten van BitMEX of gebruik een humoristische toon."></textarea>
          </div>

          <!-- Tone -->
          <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Toon & Stijl</label>
            <select id="tone" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500/50 outline-none">
              <option value="neutral">Objectief & Informatief</option>
              <option value="opinionated">Persoonlijk & Opini√´rend</option>
              <option value="direct">Direct & No-nonsense</option>
            </select>
          </div>

          <!-- FAQ toggle -->
          <div class="flex items-center pt-8">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="include_faq" checked class="w-5 h-5 rounded border-gray-700 bg-gray-950 text-yellow-500 focus:ring-yellow-500/50" />
              <span class="text-gray-300">Genereer FAQ sectie?</span>
            </label>
          </div>

          <!-- AI Model Selector -->
          <div class="col-span-2 mt-6">
            <label class="block text-sm font-medium text-gray-400 mb-3">AI Model voor Tekst</label>
            <div class="grid grid-cols-2 gap-4">
              <label class="relative flex flex-col items-center p-4 rounded-lg border-2 border-yellow-500 bg-yellow-500/10 cursor-pointer transition-all group" id="model-openai-label">
                <input type="radio" name="model_provider" value="openai" checked class="absolute opacity-0 w-full h-full cursor-pointer" />
                <span class="text-2xl mb-1">‚ö°</span>
                <span class="font-semibold text-yellow-400 text-sm">OpenAI GPT-5 mini</span>
                <span class="text-xs text-gray-500 mt-1">Snel & betrouwbaar</span>
              </label>
              <label class="relative flex flex-col items-center p-4 rounded-lg border-2 border-gray-700 bg-gray-950 cursor-pointer hover:border-gray-500 transition-all group" id="model-gemini-label">
                <input type="radio" name="model_provider" value="gemini" class="absolute opacity-0 w-full h-full cursor-pointer" />
                <span class="text-2xl mb-1">üåü</span>
                <span class="font-semibold text-gray-300 text-sm">Google Gemini 2.5 Flash</span>
                <span class="text-xs text-gray-500 mt-1">Nieuwste Google AI</span>
              </label>
            </div>
          </div>

          <!-- AI Hero Image Settings -->
          <div class="col-span-2 mt-6">
            <div class="flex items-center gap-3 mb-4">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="generate_hero_image" checked class="w-5 h-5 rounded border-gray-700 bg-gray-950 text-yellow-500 focus:ring-yellow-500/50" />
                <span class="text-sm font-medium text-gray-400">Genereer AI Hero Afbeelding</span>
              </label>
            </div>
            <div id="image-config" class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Afbeelding Provider</label>
                <select id="image_provider" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2.5 text-white text-sm focus:ring-2 focus:ring-yellow-500/50 outline-none">
                  <option value="google">üåü Google Imagen 4 ($0.02)</option>
                  <option value="openai">‚ö° OpenAI DALL-E 3 ($0.04)</option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">Afbeelding Stijl</label>
                <select id="image_style" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2.5 text-white text-sm focus:ring-2 focus:ring-yellow-500/50 outline-none">
                  <option value="futuristic">üîÆ Futuristisch</option>
                  <option value="abstract">üé® Abstract</option>
                  <option value="illustration">‚úèÔ∏è Illustratie</option>
                  <option value="photorealistic">üì∏ Fotorealistisch</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 flex justify-end">
          <button id="generate-outline-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-all flex items-center gap-2">
            GENEREER OUTLINE
            <span class="loading-spinner hidden animate-spin">‚ü≥</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Step 2: Outline Editor -->
    <section id="step-2" class="wizard-step hidden">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 sm:p-8">
        <h2 class="text-xl font-bold text-white mb-2">Outline Controleren & Aanpassen</h2>
        <p class="text-gray-400 mb-6 text-sm">Controleer de structuur voordat we gaan schrijven. Je kunt secties aanpassen, herorderen of verwijderen.</p>

        <div class="space-y-6 mb-8">
          <!-- Metadata preview -->
          <div class="grid gap-4 md:grid-cols-2 p-4 bg-gray-950 rounded-lg border border-gray-800">
            <div>
              <label class="text-xs text-gray-500 uppercase">SEO Titel</label>
              <input type="text" id="seo_title" class="w-full bg-transparent text-white font-medium border-none p-0 focus:ring-0" />
            </div>
             <div>
              <label class="text-xs text-gray-500 uppercase">Slug</label>
              <input type="text" id="slug" class="w-full bg-transparent text-gray-400 text-sm border-none p-0 focus:ring-0" />
            </div>
          </div>

          <!-- Sections List -->
          <div id="outline-sections" class="space-y-3">
            <!-- Injected via JS -->
          </div>

          <button id="add-section-btn" class="w-full py-3 border-2 border-dashed border-gray-800 rounded-lg text-gray-500 hover:border-gray-700 hover:text-gray-300 transition-all font-medium">
            +Sectie Toevoegen
          </button>
        </div>

        <div class="flex justify-between">
           <button class="back-btn text-gray-400 hover:text-white px-6 py-3">Terug</button>
           <button id="start-writing-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-all flex items-center gap-2">
            START MET SCHRIJVEN
             <span class="loading-spinner hidden animate-spin">‚ü≥</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Step 3: Writing Progress -->
    <section id="step-3" class="wizard-step hidden">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-white">Artikel Genereren...</h2>
          <div id="progress-text" class="text-yellow-500 font-mono">0%</div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-800 rounded-full h-2.5 mb-8">
          <div id="progress-bar" class="bg-yellow-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>

        <!-- Live Preview -->
        <div id="live-preview" class="space-y-8 min-h-[400px]">
          <!-- Blocks appear here -->
        </div>

         <div class="mt-8 flex justify-between hidden" id="finish-writing-controls">
           <button class="back-btn text-gray-400 hover:text-white px-6 py-3">Terug</button>
           <button id="to-review-btn" class="bg-green-500 hover:bg-green-400 text-white font-bold py-3 px-8 rounded-lg transition-all">
            NAAR REVIEW
          </button>
        </div>
      </div>
    </section>

     <!-- Step 4: Final Review -->
    <section id="step-4" class="wizard-step hidden">
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
        <h2 class="text-xl font-bold text-white mb-6">Klaar voor Publicatie?</h2>
        
        <div class="p-6 bg-gray-950 rounded-xl border border-gray-800 mb-8">
           <h3 class="font-bold text-lg text-white mb-2" id="final-title">...</h3>
           <p class="text-gray-400 mb-4" id="final-description">...</p>
           <div class="flex gap-2 text-xs text-gray-500">
             <span id="final-wordcount">0 woorden</span>
             <span>‚Ä¢</span>
             <span id="final-readingtime">0 min leestijd</span>
           </div>
        </div>

        <!-- Hero image preview -->
        <div id="hero-image-section" class="mb-8">
          <h3 class="text-sm font-medium text-gray-400 mb-3">Hero Afbeelding</h3>
          <div id="hero-image-preview" class="bg-gray-950 rounded-xl border border-gray-800 p-4 flex items-center justify-center min-h-[200px]">
            <p class="text-gray-500 text-sm" id="hero-image-status">Wordt gegenereerd bij publicatie...</p>
          </div>
        </div>

        <div class="flex justify-end gap-4">
           <button id="publish-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-lg transition-all">
            PUBLICEREN
          </button>
        </div>
      </div>
    </section>

  <!-- Add/Edit Platform Modal -->
  <dialog id="platform-modal" class="bg-gray-900 text-white p-6 rounded-xl border border-gray-800 backdrop:bg-black/80 w-full max-w-md">
    <h3 class="text-xl font-bold mb-4" id="modal-title">Nieuw Platform Toevoegen</h3>
    <form method="dialog" id="platform-form" class="space-y-4">
      <input type="hidden" name="id" id="platform-id-input" />
      <div>
        <label class="block text-sm text-gray-400 mb-1">Naam</label>
        <input type="text" name="name" id="platform-name-input" required class="w-full bg-gray-950 border border-gray-700 rounded px-3 py-2 focus:ring-yellow-500" placeholder="bv. Coinbase" />
      </div>
      <div>
        <label class="block text-sm text-gray-400 mb-1">Slug (ID)</label>
        <input type="text" name="slug" id="platform-slug-input" required pattern="[a-z0-9-]+" class="w-full bg-gray-950 border border-gray-700 rounded px-3 py-2 focus:ring-yellow-500" placeholder="bv. coinbase" />
        <p class="text-xs text-gray-500 mt-1">Kleine letters, geen spaties.</p>
      </div>
      <div>
        <label class="block text-sm text-gray-400 mb-1">Affiliate Link</label>
        <input type="url" name="affiliateLink" id="platform-link-input" class="w-full bg-gray-950 border border-gray-700 rounded px-3 py-2 focus:ring-yellow-500" placeholder="https://..." />
      </div>

       <div class="flex justify-end gap-3 mt-6">
        <button value="cancel" class="px-4 py-2 text-gray-400 hover:text-white">Annuleren</button>
        <button type="submit" id="modal-submit-btn" class="bg-yellow-500 text-gray-900 font-bold px-4 py-2 rounded hover:bg-yellow-400">Toevoegen</button>
      </div>
    </form>
  </dialog>

  </div>

  <script>
    // --- State Management ---
    const existingArticle = JSON.parse(JSON.stringify({existingArticle}));
    
    const state = {
      step: existingArticle ? 4 : 1, // Jump to review/publish if editing
      config: {initialConfig} || {},
      outline: existingArticle ? {
        title: existingArticle.title,
        seo_title: existingArticle.seo_title,
        meta_description: existingArticle.description,
        slug: existingArticle.slug,
        sections: [] // We might lost sections structure if not saved separately, but we have blocks
      } : null,
      generatedBlocks: {initialBlocks} || []
    };
    
    // Pre-fill inputs if editing
    if (existingArticle) {
       // Fill Step 1 inputs for context
       if(state.config.target_keyword) document.getElementById('target_keyword').value = state.config.target_keyword;
       if(state.config.article_type) document.getElementById('article_type').value = state.config.article_type;
       
       // Handle platforms check
       if(state.config.platforms && Array.isArray(state.config.platforms)) {
          state.config.platforms.forEach(pid => {
             const cb = document.querySelector(`input[name="platforms"][value="${pid}"]`);
             if(cb) cb.checked = true;
          });
       }

       // Fill Review Screen
       document.getElementById('final-title').innerText = existingArticle.title;
       document.getElementById('final-description').innerText = existingArticle.description;
       
       // Fill Hero Image
       if (existingArticle.heroImage) {
          const previewEl = document.getElementById('hero-image-preview');
          previewEl.innerHTML = `<img src="${existingArticle.heroImage}" alt="Hero" class="rounded-lg max-h-[300px] object-cover w-full" />`;
          document.getElementById('hero-image-status').innerText = 'Huidige afbeelding';
          // Disable generate by default if exists
          document.getElementById('generate_hero_image').checked = false;
          
          // Re-enable image config opacity change logic
           const imageConfig = document.getElementById('image-config');
           imageConfig.style.opacity = '0.4';
           imageConfig.style.pointerEvents = 'none';
       }

       // Update button text
       document.getElementById('publish-btn').innerText = 'UPDATEN';
    }

    // --- DOM Elements ---
    const steps = document.querySelectorAll('.wizard-step');
    const stepIndicators = document.querySelectorAll('.step-indicator');
    
    // --- Functions ---
    function setStep(newStep) {
      state.step = newStep;
      
      // Update UI visibility
      steps.forEach(el => el.classList.add('hidden'));
      document.getElementById(`step-${newStep}`).classList.remove('hidden');

      // Update indicators
      stepIndicators.forEach(el => {
        const s = parseInt(el.dataset.step);
        const circle = el.querySelector('.step-circle');
        const label = el.querySelector('.step-label');
        
        if (s === newStep) {
          circle.classList.add('bg-yellow-500', 'text-gray-900', 'border-yellow-500');
          circle.classList.remove('bg-gray-800', 'text-gray-400', 'border-gray-700');
          label.classList.add('text-white');
        } else if (s < newStep) {
           circle.classList.add('bg-green-500', 'text-white', 'border-green-500');
           circle.classList.remove('bg-gray-800', 'text-gray-400', 'border-gray-700', 'bg-yellow-500', 'text-gray-900');
        } else {
           circle.classList.remove('bg-yellow-500', 'text-gray-900', 'border-yellow-500', 'bg-green-500', 'text-white');
           circle.classList.add('bg-gray-800', 'text-gray-400', 'border-gray-700');
           label.classList.remove('text-white');
        }
      });
      window.scrollTo(0, 0);
    }

    // --- Step 1: Generate Outline ---
    document.getElementById('generate-outline-btn').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      const spinner = btn.querySelector('.loading-spinner');
      
      // Collect config
      const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(el => el.value);
      state.config = {
        target_keyword: document.getElementById('target_keyword').value,
        article_type: document.getElementById('article_type').value || undefined,
        monetization_priority: document.getElementById('monetization_priority').value,
        tone: document.getElementById('tone').value,
        include_faq: document.getElementById('include_faq').checked,
        target_audience: document.getElementById('target_audience').value,
        article_angle: document.getElementById('article_angle').value,
        custom_instructions: document.getElementById('custom_instructions').value,
        model_provider: document.querySelector('input[name="model_provider"]:checked')?.value || 'openai',
        generate_hero_image: document.getElementById('generate_hero_image').checked,
        image_provider: document.getElementById('image_provider').value,
        image_style: document.getElementById('image_style').value,
        platforms
      };

      if (!state.config.target_keyword) return alert('Vul een keyword in');

      // UI Loading state
      btn.disabled = true;
      spinner.classList.remove('hidden');

      try {
        const res = await fetch('/api/generate/outline', {
          method: 'POST',
          body: JSON.stringify({
            ...state.config,
            model_provider: state.config.model_provider
          })
        });
        const data = await res.json();
        
        if (data.error) throw new Error(data.error);

        state.outline = data.outline;
        renderOutline(state.outline);
        setStep(2);

      } catch (err) {
        alert('Fout: ' + err.message);
      } finally {
        btn.disabled = false;
        spinner.classList.add('hidden');
      }
    });

    function renderOutline(outline) {
      document.getElementById('seo_title').value = outline.seo_title;
      document.getElementById('slug').value = outline.slug;
      
      const container = document.getElementById('outline-sections');
      container.innerHTML = '';

      outline.sections.forEach((section, idx) => {
        appendSection(section);
      });
    }

    function appendSection(section) {
      const container = document.getElementById('outline-sections');
      const div = document.createElement('div');
      div.className = 'p-4 bg-gray-950 rounded-lg border border-gray-800 flex gap-4 group transition-all outline-item';
      div.dataset.blockId = section.block_id;
      div.innerHTML = `
        <div class="flex flex-col gap-2 items-center text-gray-600 pt-1">
          <button class="move-up-btn hover:text-white" title="Omhoog">‚ñ≤</button>
          <div class="text-xs font-mono sequence-number">${container.children.length + 1}</div>
          <button class="move-down-btn hover:text-white" title="Omlaag">‚ñº</button>
        </div>
        <div class="flex-1 space-y-2">
          <input class="w-full bg-transparent font-semibold text-gray-200 focus:text-white border-b border-transparent focus:border-gray-700 p-0 focus:ring-0 mb-1 section-heading" value="${section.heading}" placeholder="Heading" />
          <textarea class="w-full bg-transparent text-sm text-gray-400 focus:text-gray-300 border-none p-0 focus:ring-0 resize-none section-summary" rows="2" placeholder="Wat moet hier besproken worden?">${section.summary}</textarea>
        </div>
        <div class="flex flex-col items-end justify-between">
          <button class="remove-section-btn text-gray-700 hover:text-red-500 transition-colors" title="Verwijder">‚úï</button>
          <span class="text-[10px] uppercase font-mono text-gray-800 bg-gray-900 px-1.5 py-0.5 rounded border border-gray-800">${section.block_id}</span>
        </div>
      `;
      container.appendChild(div);
      attachOutlineEventListeners(div);
    }

    function attachOutlineEventListeners(el) {
      el.querySelector('.move-up-btn').addEventListener('click', () => swapNodes(el, 'up'));
      el.querySelector('.move-down-btn').addEventListener('click', () => swapNodes(el, 'down'));
      el.querySelector('.remove-section-btn').addEventListener('click', () => {
        el.remove();
        updateSequenceNumbers();
      });
    }

    function swapNodes(node, direction) {
      const container = document.getElementById('outline-sections');
      if (direction === 'up') {
        if (node.previousElementSibling) {
          container.insertBefore(node, node.previousElementSibling);
        }
      } else {
        if (node.nextElementSibling) {
          container.insertBefore(node.nextElementSibling, node);
        }
      }
      updateSequenceNumbers();
    }

    function updateSequenceNumbers() {
      const items = document.querySelectorAll('.outline-item');
      items.forEach((item, idx) => {
        item.querySelector('.sequence-number').innerText = idx + 1;
      });
    }

    document.getElementById('add-section-btn').addEventListener('click', () => {
      appendSection({
        heading: 'Nieuwe Sectie',
        summary: 'Beschrijf de inhoud...',
        block_id: 'custom_' + Math.random().toString(36).substring(7)
      });
      updateSequenceNumbers();
    });

    // --- Step 2: Start Writing ---
    document.getElementById('start-writing-btn').addEventListener('click', async () => {
      // Sync DOM back to state.outline
      const items = document.querySelectorAll('.outline-item');
      state.outline.sections = Array.from(items).map(item => ({
        heading: item.querySelector('.section-heading').value,
        summary: item.querySelector('.section-summary').value,
        block_id: item.dataset.blockId,
        level: 'h2' // default
      }));
      state.outline.seo_title = document.getElementById('seo_title').value;
      state.outline.slug = document.getElementById('slug').value;

      setStep(3);
      await generateAllBlocks();
    });

    async function generateAllBlocks() {
      const container = document.getElementById('live-preview');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      
      container.innerHTML = '';
      state.generatedBlocks = [];
      const sections = state.outline.sections;
      const total = sections.length;

      for (let i = 0; i < total; i++) {
        const section = sections[i];
        
        // Create placeholder
        const placeholder = document.createElement('div');
        placeholder.className = 'p-6 bg-gray-900/50 rounded-xl border border-gray-800 animate-pulse';
        placeholder.innerHTML = `<div class="h-4 bg-gray-800 rounded w-1/3 mb-4"></div><div class="space-y-2"><div class="h-3 bg-gray-800 rounded w-full"></div><div class="h-3 bg-gray-800 rounded w-5/6"></div></div>`;
        container.appendChild(placeholder);

        // Scroll to bottom
        window.scrollTo(0, document.body.scrollHeight);

        try {
          // API Call
          const res = await fetch('/api/generate/block', {
             method: 'POST',
             body: JSON.stringify({
               block_id: section.block_id,
               block_label: section.heading,
               block_description: section.summary,
               outline: state.outline,
               platforms: state.config.platforms,
               previous_blocks: state.generatedBlocks.map(b => ({ block_id: b.block_id, content: b.content })),
               tone: state.config.tone,
               target_keyword: state.config.target_keyword,
               model_provider: state.config.model_provider
             })
          });
          
          const blockData = await res.json();
          
          // Replace placeholder with real content
          placeholder.className = 'article-block prose prose-invert max-w-none p-6 bg-transparent border-b border-gray-800/50 last:border-0';
          placeholder.innerHTML = `
            <h3 class="text-xl font-bold text-white mb-4">${blockData.heading}</h3>
            <div class="whitespace-pre-wrap text-gray-300">${blockData.content}</div>
          `;
          placeholder.classList.remove('animate-pulse');

          state.generatedBlocks.push(blockData);

          // Update progress
          const pct = Math.round(((i + 1) / total) * 100);
          progressBar.style.width = pct + '%';
          progressText.innerText = pct + '%';

        } catch (err) {
          console.error(err);
          placeholder.innerHTML = `<div class="text-red-500">Error generating block: ${err.message}</div>`;
        }
      }

      // Finish
      document.getElementById('finish-writing-controls').classList.remove('hidden');
    }

    // --- Navigation Handlers ---
    document.querySelectorAll('.back-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (state.step > 1) setStep(state.step - 1);
      });
    });

    document.getElementById('to-review-btn').addEventListener('click', () => {
      // Fill review data
      document.getElementById('final-title').innerText = state.outline.title;
      document.getElementById('final-description').innerText = state.outline.meta_description;
       
      const totalWords = state.generatedBlocks.reduce((acc, b) => acc + b.content.split(/\s+/).length, 0);
      document.getElementById('final-wordcount').innerText = totalWords + ' woorden';
      document.getElementById('final-readingtime').innerText = Math.ceil(totalWords / 200) + ' min leestijd';

      setStep(4);
    });

    document.getElementById('save-draft-btn').addEventListener('click', () => {
      alert('Draft saving logic here');
    });

    document.getElementById('publish-btn').addEventListener('click', async () => {
      const btn = document.getElementById('publish-btn');
      btn.disabled = true;
      btn.innerText = existingArticle ? 'Bezig met updaten...' : 'Bezig met opslaan...';

      try {
        // Step 1: Generate hero image if enabled
        let heroImage = existingArticle?.heroImage || `https://placehold.co/1200x630/111827/EAB308?text=${encodeURIComponent(state.outline.title.substring(0, 40))}`;

        if (state.config.generate_hero_image) {
          btn.innerText = 'üé® Afbeelding genereren...';
          const statusEl = document.getElementById('hero-image-status');
          if (statusEl) statusEl.innerText = 'AI genereert je hero afbeelding...';

          try {
            const imgRes = await fetch('/api/generate/image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title: state.outline.title,
                keyword: state.config.target_keyword || state.outline.title,
                slug: state.outline.slug,
                provider: state.config.image_provider,
                style: state.config.image_style,
              })
            });
            const imgData = await imgRes.json();
            if (imgData.success && imgData.imageUrl) {
              heroImage = imgData.imageUrl;
              // Show preview
              const previewEl = document.getElementById('hero-image-preview');
              if (previewEl) {
                previewEl.innerHTML = `<img src="${imgData.imageUrl}" alt="Hero" class="rounded-lg max-h-[300px] object-cover w-full" />`;
              }
            } else {
              console.warn('Image generation failed:', imgData.error);
              if (statusEl) statusEl.innerText = '‚ö†Ô∏è Afbeelding gefaald, oude/placeholder gebruikt.';
            }
          } catch (imgErr) {
            console.warn('Image generation error:', imgErr);
          }
        }

        btn.innerText = existingArticle ? 'üìù Artikel updaten...' : 'üìù Artikel opslaan...';

        // Step 2: Save the article
        const payload = {
          title: state.outline.title,
          description: state.outline.meta_description,
          slug: state.outline.slug,
          heroImage,
          pubDate: existingArticle?.pubDate || new Date().toISOString(),
          target_keyword: state.config.target_keyword,
          seo_title: state.outline.seo_title,
          article_type: state.config.article_type,
          blocks: state.generatedBlocks,
          platforms: state.config.platforms,
          status: existingArticle?.status || 'published' // Keep existing status or default to published
        };

        const method = existingArticle ? 'PUT' : 'POST';
        const url = existingArticle ? `/api/articles/${existingArticle.slug}` : '/api/articles';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
           window.location.href = '/dashboard?success=saved';
        } else {
           const errData = await res.json();
           throw new Error(errData.error || 'Save failed');
        }
      } catch (err) {
        alert('Fout bij opslaan: ' + err.message);
        btn.disabled = false;
        btn.innerText = existingArticle ? 'UPDATEN' : 'PUBLICEREN';
      }
    });

    // --- AI Model Selector Toggle ---
    document.querySelectorAll('input[name="model_provider"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const openaiLabel = document.getElementById('model-openai-label');
        const geminiLabel = document.getElementById('model-gemini-label');
        if (radio.value === 'openai') {
          openaiLabel.classList.add('border-yellow-500', 'bg-yellow-500/10');
          openaiLabel.classList.remove('border-gray-700', 'bg-gray-950');
          openaiLabel.querySelector('.font-semibold').classList.add('text-yellow-400');
          openaiLabel.querySelector('.font-semibold').classList.remove('text-gray-300');
          geminiLabel.classList.remove('border-yellow-500', 'bg-yellow-500/10');
          geminiLabel.classList.add('border-gray-700', 'bg-gray-950');
          geminiLabel.querySelector('.font-semibold').classList.remove('text-yellow-400');
          geminiLabel.querySelector('.font-semibold').classList.add('text-gray-300');
        } else {
          geminiLabel.classList.add('border-yellow-500', 'bg-yellow-500/10');
          geminiLabel.classList.remove('border-gray-700', 'bg-gray-950');
          geminiLabel.querySelector('.font-semibold').classList.add('text-yellow-400');
          geminiLabel.querySelector('.font-semibold').classList.remove('text-gray-300');
          openaiLabel.classList.remove('border-yellow-500', 'bg-yellow-500/10');
          openaiLabel.classList.add('border-gray-700', 'bg-gray-950');
          openaiLabel.querySelector('.font-semibold').classList.remove('text-yellow-400');
          openaiLabel.querySelector('.font-semibold').classList.add('text-gray-300');
        }
      });
    });

    // --- Hero Image Toggle ---
    document.getElementById('generate_hero_image').addEventListener('change', (e) => {
      const imageConfig = document.getElementById('image-config');
      imageConfig.style.opacity = e.target.checked ? '1' : '0.4';
      imageConfig.style.pointerEvents = e.target.checked ? 'auto' : 'none';
    });

    // --- Platform Management ---
    const platformModal = document.getElementById('platform-modal');
    const platformForm = document.getElementById('platform-form');
    const platformList = document.getElementById('platform-list');
    const addPlatformBtn = document.getElementById('add-platform-btn');

    addPlatformBtn.addEventListener('click', () => {
      document.getElementById('modal-title').innerText = 'Nieuw Platform Toevoegen';
      document.getElementById('modal-submit-btn').innerText = 'Toevoegen';
      document.getElementById('platform-id-input').value = '';
      platformForm.reset();
      platformModal.showModal();
    });

    // Delegate Edit/Delete clicks
    platformList.addEventListener('click', (e) => {
      const editBtn = e.target.closest('.edit-platform-btn');
      const deleteBtn = e.target.closest('.delete-platform-btn');

      if (editBtn) {
        const platform = JSON.parse(editBtn.dataset.platform);
        document.getElementById('modal-title').innerText = `Bewerk ${platform.name}`;
        document.getElementById('modal-submit-btn').innerText = 'Opslaan';
        document.getElementById('platform-id-input').value = platform.id;
        document.getElementById('platform-name-input').value = platform.name;
        document.getElementById('platform-slug-input').value = platform.slug;
        document.getElementById('platform-link-input').value = platform.affiliateLink || '';
        platformModal.showModal();
      }

      if (deleteBtn) {
        if (confirm('Weet je zeker dat je dit platform wilt verwijderen?')) {
          const id = deleteBtn.dataset.id;
          deletePlatform(id);
        }
      }
    });

    async function deletePlatform(id) {
       try {
        const res = await fetch('/api/platforms', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        if (res.ok) {
          document.querySelector(`[data-platform-id="${id}"]`).remove();
        }
      } catch (err) {
        alert('Fout bij verwijderen: ' + err.message);
      }
    }

    platformForm.addEventListener('submit', async (e) => {
      if (e.submitter.value === 'cancel') return;
      e.preventDefault();

      const formData = new FormData(platformForm);
      const data = Object.fromEntries(formData.entries());
      const isEdit = !!data.id;

      try {
        const res = await fetch('/api/platforms', {
          method: isEdit ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) throw new Error('Failed to save platform');

        // Fast path: just refresh the page for platform updates to keep it simple and sync data-attributes
        window.location.reload();

      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

  </script>

  <style>
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .wizard-step {
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</DashboardLayout>
