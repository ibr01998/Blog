---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import AgentLogViewer from '../../components/AgentLogViewer.astro';
import { query } from '../../lib/db/postgres.ts';

// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface AgentRow {
  id: string;
  name: string;
  role: string;
  personality_config: Record<string, unknown>;
  behavior_overrides: Record<string, unknown>;
  performance_score: number;
  article_slots: number;
  is_active: boolean;
  created_at: string;
}

interface EvoLogRow {
  id: string;
  stage: string;
  input_summary: Record<string, any>;
  decision_summary: Record<string, any>;
  reasoning_summary: string | null;
  created_at: string;
  // Resolved writer agent info via JOIN on input_summary->>'agent_id'
  writer_id: string | null;
  writer_name: string | null;
  writer_role: string | null;
}

// â”€â”€â”€ Data Fetching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let agents: AgentRow[] = [];
let evoLogs: EvoLogRow[] = [];
let dbError = '';

try {
  [agents, evoLogs] = await Promise.all([
    query<AgentRow>(
      `SELECT id, name, role, personality_config, behavior_overrides,
              performance_score, article_slots, is_active, created_at
       FROM agents ORDER BY role, performance_score DESC`
    ),
    // Join on the WRITER agent from input_summary->>'agent_id' (not the analyst's agent_id)
    query<EvoLogRow>(
      `SELECT
         al.id, al.stage,
         al.input_summary, al.decision_summary, al.reasoning_summary,
         al.created_at,
         wa.id   AS writer_id,
         wa.name AS writer_name,
         wa.role AS writer_role
       FROM agent_logs al
       LEFT JOIN agents wa
         ON al.input_summary->>'agent_id' ~ '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
         AND wa.id::text = al.input_summary->>'agent_id'
       WHERE al.stage IN ('evolution:suggestion', 'evolution:applied', 'performance:snapshot')
       ORDER BY al.created_at ASC
       LIMIT 300`
    ),
  ]);
} catch (err) {
  dbError = err instanceof Error ? err.message : 'Database niet beschikbaar';
}

// Specific agent logs for the log viewer (when ?agent_id= is set)
const selectedAgentId = Astro.url.searchParams.get('agent_id');
let agentLogs: any[] = [];
if (selectedAgentId) {
  try {
    agentLogs = await query(
      `SELECT al.*, ag.name as agent_name, ag.role as agent_role
       FROM agent_logs al
       LEFT JOIN agents ag ON al.agent_id = ag.id
       WHERE al.agent_id = $1
       ORDER BY al.created_at DESC
       LIMIT 30`,
      [selectedAgentId]
    );
  } catch {}
}

// â”€â”€â”€ Evolution Data Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface DataPoint {
  date: string;
  score: number;
  ctr: number;
  conv: number;
  stage: string;
}

/** All historic data points for a given writer agent (reconstructed from logs). */
function getHistory(agentId: string): DataPoint[] {
  return evoLogs
    .filter(l =>
      (l.writer_id === agentId || l.input_summary?.agent_id === agentId) &&
      l.input_summary?.avg_ctr !== undefined &&
      l.input_summary?.avg_ctr !== null
    )
    .map(l => {
      const ctr  = Number(l.input_summary.avg_ctr ?? 0);
      const conv = Number(l.input_summary.avg_conversion_rate ?? 0);
      const score = l.input_summary.performance_score !== undefined
        ? Number(l.input_summary.performance_score)
        : Math.min(1.0, Math.max(0.0, (ctr * 0.4) + (conv * 0.6)));
      return { date: l.created_at, score, ctr, conv, stage: l.stage };
    })
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
}

function countApplied(agentId: string): number {
  return evoLogs.filter(l =>
    l.stage === 'evolution:applied' &&
    (l.writer_id === agentId || l.input_summary?.agent_id === agentId)
  ).length;
}

function lastMetrics(agentId: string): { ctr: number; conv: number } | null {
  const pts = getHistory(agentId);
  if (!pts.length) return null;
  const last = pts[pts.length - 1];
  return { ctr: last.ctr, conv: last.conv };
}

// â”€â”€â”€ SVG Sparkline Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _svgCounter = 0;

function sparkline(scores: number[], width = 160, height = 48): string {
  ++_svgCounter; // keep counter advancing for potential future use

  if (scores.length === 0) {
    return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
      <line x1="8" y1="${height / 2}" x2="${width - 8}" y2="${height / 2}" stroke="#e5e7eb" stroke-width="1.5" stroke-dasharray="4,3"/>
      <text x="${width / 2}" y="${height / 2 + 5}" text-anchor="middle" fill="#9ca3af" font-size="9" font-family="system-ui">geen data</text>
    </svg>`;
  }

  const pad = 7;
  const iW  = width  - pad * 2;
  const iH  = height - pad * 2;

  const pts = scores.map((v, i) => ({
    x: pad + (i / Math.max(1, scores.length - 1)) * iW,
    y: pad + (1 - Math.min(1, Math.max(0, v))) * iH,
  }));

  const delta = scores[scores.length - 1] - scores[0];
  const stroke = delta > 0.03 ? '#10b981' : delta < -0.03 ? '#ef4444' : '#6366f1';
  const fill   = delta > 0.03 ? '#dcfce7' : delta < -0.03 ? '#fee2e2' : '#e0e7ff';

  const line = pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
  const area = [
    `${pts[0].x.toFixed(1)},${height - pad}`,
    ...pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`),
    `${pts[pts.length - 1].x.toFixed(1)},${height - pad}`,
  ].join(' ');
  const lp = pts[pts.length - 1];

  return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
    <polygon points="${area}" fill="${fill}" opacity="0.6"/>
    <polyline points="${line}" fill="none" stroke="${stroke}" stroke-width="1.8" stroke-linejoin="round" stroke-linecap="round"/>
    <circle cx="${lp.x.toFixed(1)}" cy="${lp.y.toFixed(1)}" r="2.8" fill="${stroke}" stroke="white" stroke-width="1.5"/>
  </svg>`;
}

function miniSparkline(scores: number[]): string {
  return sparkline(scores, 72, 24);
}

// â”€â”€â”€ Trend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function trend(scores: number[]): { arrow: string; cls: string; label: string } {
  if (scores.length < 2) return { arrow: 'â€”', cls: 'text-gray-400', label: 'stabiel' };
  const delta = scores[scores.length - 1] - scores[0];
  if (delta > 0.03)  return { arrow: 'â†‘', cls: 'text-emerald-500', label: `+${(delta * 100).toFixed(0)}%` };
  if (delta < -0.03) return { arrow: 'â†“', cls: 'text-red-500',     label: `${(delta * 100).toFixed(0)}%`  };
  return { arrow: 'â†’', cls: 'text-indigo-400', label: 'stabiel' };
}

// â”€â”€â”€ Date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function relDate(iso: string): string {
  const d = Math.floor((Date.now() - new Date(iso).getTime()) / 86400000);
  if (d === 0) return 'Vandaag';
  if (d === 1) return 'Gisteren';
  if (d < 7)  return `${d}d geleden`;
  if (d < 30) return `${Math.floor(d / 7)}w geleden`;
  return `${Math.floor(d / 30)}mo geleden`;
}

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ROLE_LABELS: Record<string, string> = {
  analyst: 'Analyst', strategist: 'Strateeg', editor: 'Redacteur',
  writer: 'Schrijver', humanizer: 'Humanizer', seo: 'SEO',
  fact_checker: 'Feiten-Checker', researcher: 'Onderzoeker',
};

const ROLE_COLORS: Record<string, string> = {
  analyst:      'bg-blue-100 text-blue-800',
  strategist:   'bg-purple-100 text-purple-800',
  editor:       'bg-amber-100 text-amber-800',
  writer:       'bg-green-100 text-green-800',
  humanizer:    'bg-teal-100 text-teal-800',
  seo:          'bg-indigo-100 text-indigo-800',
  fact_checker: 'bg-red-100 text-red-800',
  researcher:   'bg-cyan-100 text-cyan-800',
};

const ROLE_ICONS: Record<string, string> = {
  analyst: 'ğŸ“Š', strategist: 'ğŸ¯', editor: 'âœï¸',
  writer: 'ğŸ“',  humanizer: 'ğŸ«€', seo: 'ğŸ”',
  fact_checker: 'âœ…', researcher: 'ğŸ”¬',
};

const OVERRIDE_LABELS: Record<string, string> = {
  reduce_hype:             'minder hype',
  increase_assertiveness:  'meer assertief',
  lower_wordcount:         'kortere content',
  avoid_platform:          'platform vermijden',
  keyword_density_target:  'keyword dichtheid',
  force_tone:              'toon aanpassen',
  max_affiliate_links:     'max affiliate links',
};

// â”€â”€â”€ Derived data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const EVOLVABLE = ['writer', 'humanizer', 'seo'];
const evolvable = agents.filter(a => EVOLVABLE.includes(a.role));

// Sorted timeline (most recent first, exclude snapshot entries)
const timeline = evoLogs
  .filter(l => l.stage !== 'performance:snapshot')
  .slice()
  .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
  .slice(0, 20);

const totalSuggestions = evoLogs.filter(l => l.stage === 'evolution:suggestion').length;
const totalApplied     = evoLogs.filter(l => l.stage === 'evolution:applied').length;
// Count unique cycle dates from snapshots as a proxy for cycle count
// Note: created_at may be a Date object (neon parses TIMESTAMPTZ), so normalize to ISO string first
const cycleDates = new Set(
  evoLogs.filter(l => l.stage === 'performance:snapshot').map(l =>
    new Date(l.created_at as any).toISOString().slice(0, 10)
  )
);
const totalCycles = cycleDates.size;
---

<DashboardLayout title="AI Agents" activePage="agents">
  <div class="space-y-6">

    <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-bold text-navy">AI Agents</h2>
        <p class="text-sm text-gray-500 mt-1">Agents, gedragsregels en evolutie door de tijd.</p>
      </div>
      <button id="migrate-btn"
        class="text-xs bg-navy text-white px-3 py-1.5 rounded-lg hover:bg-navy/90 transition-colors">
        {agents.length === 0 ? 'Database Initialiseren' : 'Database Synchroniseren'}
      </button>
    </div>

    {dbError && (
      <div class="glass rounded-xl p-4 border border-red-200">
        <p class="text-sm text-red-600"><strong>Fout:</strong> {dbError}</p>
        <p class="text-xs text-gray-500 mt-1">
          Voer <code class="bg-gray-100 px-1 rounded">POST /api/admin/migrate</code> uit om de database te initialiseren.
        </p>
      </div>
    )}

    <!-- â”€â”€ ğŸ§¬ Evolution Radar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {evolvable.length > 0 && (
      <div class="glass rounded-xl border border-white/20 overflow-hidden">

        <!-- Panel header -->
        <div class="px-5 pt-5 pb-4 border-b border-white/10 flex items-start justify-between gap-4">
          <div>
            <h3 class="text-sm font-bold text-navy flex items-center gap-2">
              <span class="text-lg">ğŸ§¬</span>
              Evolutie Radar
            </h3>
            <p class="text-xs text-gray-400 mt-0.5">
              Prestatietrend van evolueerbare agents â€” bijgewerkt elke redactionele cyclus
            </p>
          </div>
          <!-- Stats chips -->
          <div class="flex items-center gap-2 shrink-0 flex-wrap justify-end">
            <span class="text-xs bg-gray-100 text-gray-600 px-2.5 py-1 rounded-full font-mono whitespace-nowrap">
              {totalCycles} {totalCycles === 1 ? 'cyclus' : 'cycli'}
            </span>
            <span class="text-xs bg-amber-50 text-amber-700 px-2.5 py-1 rounded-full font-mono border border-amber-200 whitespace-nowrap">
              {totalSuggestions} suggesties
            </span>
            <span class="text-xs bg-emerald-50 text-emerald-700 px-2.5 py-1 rounded-full font-mono border border-emerald-200 whitespace-nowrap">
              {totalApplied} toegepast
            </span>
          </div>
        </div>

        <!-- Agent sparkline cards grid -->
        <div class={`grid divide-x divide-white/10 ${evolvable.length === 1 ? 'grid-cols-1' : evolvable.length === 2 ? 'grid-cols-2' : 'grid-cols-3'}`}>
          {evolvable.map(agent => {
            const history     = getHistory(agent.id);
            const scores      = history.map(h => h.score);
            const t           = trend(scores);
            const metrics     = lastMetrics(agent.id);
            const applied     = countApplied(agent.id);
            const svgMain     = sparkline(scores, 160, 52);
            const scoreLabel  = Math.round(agent.performance_score * 100);
            const overrideKeys = Object.keys(agent.behavior_overrides ?? {});

            return (
              <div class="p-5 hover:bg-white/40 transition-colors">
                <!-- Agent name + score -->
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <span class="text-xl leading-none">{ROLE_ICONS[agent.role] ?? 'ğŸ¤–'}</span>
                    <div>
                      <div class="text-xs font-bold text-navy leading-tight">{agent.name}</div>
                      <span class={`text-xs px-1.5 py-0.5 rounded-full mt-0.5 inline-block ${ROLE_COLORS[agent.role] ?? 'bg-gray-100 text-gray-600'}`}>
                        {ROLE_LABELS[agent.role] ?? agent.role}
                      </span>
                    </div>
                  </div>
                  <div class="text-right shrink-0 ml-2">
                    <div class="text-2xl font-black font-mono text-navy leading-none">{scoreLabel}<span class="text-sm font-normal text-gray-400">%</span></div>
                    <div class={`text-xs font-semibold mt-0.5 ${t.cls}`}>{t.arrow} {t.label}</div>
                  </div>
                </div>

                <!-- Sparkline -->
                <div class="rounded-lg overflow-hidden bg-gray-50 border border-gray-100 mb-3">
                  <Fragment set:html={svgMain} />
                </div>

                <!-- Metrics row -->
                <div class="flex items-center justify-between text-xs mb-2">
                  <div class="flex gap-3 text-gray-500">
                    {metrics ? (
                      <>
                        <span>CTR <strong class="text-gray-700">{(metrics.ctr * 100).toFixed(1)}%</strong></span>
                        <span>Conv <strong class="text-gray-700">{(metrics.conv * 100).toFixed(1)}%</strong></span>
                      </>
                    ) : (
                      <span class="text-gray-400 italic">Nog geen meting</span>
                    )}
                  </div>
                  <span class={`px-2 py-0.5 rounded-full border text-xs whitespace-nowrap ${applied > 0 ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                    {applied === 0 ? 'geen overrides' : `${applied}Ã— geÃ«volueerd`}
                  </span>
                </div>

                <!-- Active overrides preview -->
                {overrideKeys.length > 0 && (
                  <div class="flex flex-wrap gap-1 pt-2 border-t border-gray-100">
                    {overrideKeys.slice(0, 4).map(k => (
                      <span class="text-xs bg-indigo-50 text-indigo-600 border border-indigo-200 px-1.5 py-0.5 rounded-full">
                        {OVERRIDE_LABELS[k] ?? k}
                      </span>
                    ))}
                    {overrideKeys.length > 4 && (
                      <span class="text-xs text-gray-400 self-center">+{overrideKeys.length - 4}</span>
                    )}
                  </div>
                )}

                {scores.length === 0 && (
                  <p class="text-xs text-gray-400 italic text-center pt-1">
                    Wacht op eerste cyclusâ€¦
                  </p>
                )}
              </div>
            );
          })}
        </div>
      </div>
    )}

    <!-- â”€â”€ ğŸ“… Evolution Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {timeline.length > 0 ? (
      <div class="glass rounded-xl border border-white/20 p-5">
        <h3 class="text-sm font-bold text-navy mb-5 flex items-center gap-2">
          <span class="text-base">ğŸ“…</span>
          Evolutie Tijdlijn
          <span class="text-xs font-normal text-gray-400 ml-1">
            â€” gesuggereerde en toegepaste aanpassingen
          </span>
        </h3>

        <div class="relative pl-7">
          <!-- Vertical line -->
          <div class="absolute left-3 top-1 bottom-1 w-px bg-gradient-to-b from-navy/20 via-gray-200 to-transparent pointer-events-none"></div>

          <div class="space-y-5">
            {timeline.map(event => {
              const applied = event.stage === 'evolution:applied';
              const overrides = event.decision_summary?.suggested_overrides ?? {};
              const activeOverrides = Object.entries(overrides).filter(([, v]) => v !== null && v !== undefined);
              const agentName = event.writer_name ?? event.input_summary?.agent_name ?? 'Onbekend';
              const agentRole = event.writer_role ?? '';
              const ctr  = event.input_summary?.avg_ctr;
              const conv = event.input_summary?.avg_conversion_rate;

              return (
                <div class="relative flex gap-4">
                  <!-- Dot -->
                  <div class={`absolute -left-7 top-1 w-4 h-4 rounded-full border-2 flex items-center justify-center shrink-0 ${
                    applied ? 'bg-emerald-500 border-emerald-500' : 'bg-white border-amber-400'
                  }`}>
                    {applied && (
                      <svg class="w-2 h-2" viewBox="0 0 10 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 4L3.5 6.5L9 1" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    )}
                  </div>

                  <!-- Content -->
                  <div class="flex-1 min-w-0 pb-1">
                    <!-- Header row -->
                    <div class="flex items-center gap-2 flex-wrap mb-1.5">
                      <span class="text-xs font-mono text-gray-400">{relDate(event.created_at)}</span>
                      <span class={`text-xs px-2 py-0.5 rounded-full font-medium ${
                        applied ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'
                      }`}>
                        {applied ? 'âœ“ Toegepast' : 'â³ Suggestie'}
                      </span>
                      {agentName !== 'Onbekend' && (
                        <span class={`text-xs px-1.5 py-0.5 rounded-full ${ROLE_COLORS[agentRole] ?? 'bg-gray-100 text-gray-600'}`}>
                          {agentName}
                        </span>
                      )}
                      {(ctr !== null && ctr !== undefined) && (
                        <span class="text-xs text-gray-400">
                          CTR {(Number(ctr) * 100).toFixed(1)}%
                          {conv !== null && conv !== undefined && ` Â· Conv ${(Number(conv) * 100).toFixed(1)}%`}
                        </span>
                      )}
                    </div>

                    <!-- Reasoning -->
                    {event.reasoning_summary && (
                      <p class="text-xs text-gray-500 leading-relaxed mb-2 line-clamp-2">
                        {event.reasoning_summary}
                      </p>
                    )}

                    <!-- Override tags -->
                    {activeOverrides.length > 0 && (
                      <div class="flex flex-wrap gap-1">
                        {activeOverrides.map(([key, val]) => (
                          <span class={`text-xs px-2 py-0.5 rounded-full border font-mono ${
                            applied
                              ? 'bg-emerald-50 text-emerald-700 border-emerald-200'
                              : 'bg-amber-50 text-amber-700 border-amber-200'
                          }`}>
                            {OVERRIDE_LABELS[key] ?? key}
                            {typeof val === 'string'  && `: "${val}"`}
                            {typeof val === 'number'  && `: ${val}`}
                            {val === true             && ': aan'}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    ) : (
      <div class="glass rounded-xl border border-white/20 p-8 text-center">
        <div class="text-4xl mb-3">ğŸ§¬</div>
        <h3 class="text-sm font-semibold text-navy mb-1">Geen evolutiedata</h3>
        <p class="text-xs text-gray-400 leading-relaxed">
          De Analyst registreert prestatiedata en evolutiesuggesties tijdens elke redactionele cyclus.<br/>
          Start een cyclus via het <a href="/dashboard/system" class="text-navy underline underline-offset-2">Systeem dashboard</a>.
        </p>
      </div>
    )}

    <!-- â”€â”€ All Agent Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {agents.length > 0 && (
      <div class="space-y-3">
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-widest">Alle Agents</h3>
        {agents.map(agent => {
          const scores = getHistory(agent.id).map(h => h.score);
          const mini   = miniSparkline(scores);
          const overrideKeys = Object.keys(agent.behavior_overrides ?? {});

          return (
            <div
              class={`glass rounded-xl border border-white/20 p-5 transition-all ${!agent.is_active ? 'opacity-50' : ''}`}
              id={`agent-${agent.id}`}
            >
              <div class="flex items-start gap-4">
                <div class="flex-1 min-w-0">
                  <!-- Name + role badge -->
                  <div class="flex items-center gap-2 mb-2 flex-wrap">
                    <span class={`text-xs font-semibold px-2 py-0.5 rounded-full ${ROLE_COLORS[agent.role] ?? 'bg-gray-100 text-gray-600'}`}>
                      {ROLE_LABELS[agent.role] ?? agent.role}
                    </span>
                    <h3 class="text-sm font-semibold text-navy">{agent.name}</h3>
                    {!agent.is_active && (
                      <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">Inactief</span>
                    )}
                  </div>

                  <!-- Performance bar + mini sparkline -->
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-500 w-20 shrink-0">Prestatie</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-1.5">
                      <div
                        class="bg-navy rounded-full h-1.5 transition-all"
                        style={`width: ${Math.round(agent.performance_score * 100)}%`}
                      ></div>
                    </div>
                    <span class="text-xs font-mono text-gray-600 w-10 text-right">
                      {(agent.performance_score * 100).toFixed(0)}%
                    </span>
                    <!-- Mini trend sparkline -->
                    <div class="shrink-0 rounded overflow-hidden opacity-80">
                      <Fragment set:html={mini} />
                    </div>
                  </div>

                  <!-- Active override tags -->
                  {overrideKeys.length > 0 && (
                    <div class="flex flex-wrap gap-1 mt-2">
                      {overrideKeys.map(k => (
                        <span class="text-xs bg-indigo-50 text-indigo-600 border border-indigo-200 px-2 py-0.5 rounded-full">
                          {OVERRIDE_LABELS[k] ?? k}
                        </span>
                      ))}
                    </div>
                  )}

                  <div class="text-xs text-gray-400 mt-1.5">
                    Artikel slots: {agent.article_slots}
                  </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center gap-2 shrink-0">
                  <a
                    href={`/dashboard/agent-logs?agent_id=${agent.id}`}
                    class="text-xs text-gray-500 hover:text-navy px-2 py-1.5 rounded-lg hover:bg-gray-100 transition-colors"
                  >
                    Logs
                  </a>
                  <button
                    class="toggle-active-btn text-xs px-3 py-1.5 rounded-lg border transition-colors font-medium"
                    data-agent-id={agent.id}
                    data-is-active={String(agent.is_active)}
                    style={agent.is_active
                      ? 'border-color: rgb(209 213 219); color: rgb(107 114 128);'
                      : 'background: rgb(27 45 79); color: white;'}
                  >
                    {agent.is_active ? 'Bevriezen' : 'Activeren'}
                  </button>
                </div>
              </div>

              <!-- Behavior Overrides Editor -->
              <div class="mt-4 pt-4 border-t border-white/10">
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">
                  Gedragsregels (behavior_overrides)
                </label>
                <div class="flex gap-2">
                  <textarea
                    class="overrides-textarea flex-1 text-xs font-mono bg-gray-50 border border-gray-200 rounded-lg p-2 h-24 resize-none focus:outline-none focus:ring-1 focus:ring-navy/30"
                    data-agent-id={agent.id}
                    placeholder="{}"
                  >{JSON.stringify(agent.behavior_overrides ?? {}, null, 2)}</textarea>
                  <button
                    class="save-overrides-btn self-start text-xs bg-navy text-white px-3 py-1.5 rounded-lg hover:bg-navy/90 transition-colors whitespace-nowrap"
                    data-agent-id={agent.id}
                  >
                    Opslaan
                  </button>
                </div>
                <p class="text-xs text-gray-400 mt-1">
                  Sleutels: reduce_hype, increase_assertiveness, lower_wordcount, avoid_platform, keyword_density_target
                </p>
              </div>
            </div>
          );
        })}
      </div>
    )}

    <!-- â”€â”€ Agent Log Viewer (when ?agent_id= set) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {selectedAgentId && agentLogs.length > 0 && (
      <div class="glass rounded-xl border border-white/20 p-6">
        <h3 class="text-sm font-semibold text-navy mb-4">
          Recente Logs â€” {agents.find(a => a.id === selectedAgentId)?.name ?? selectedAgentId}
        </h3>
        <AgentLogViewer logs={agentLogs} showAgentName={false} showArticleId={true} />
      </div>
    )}

  </div>
</DashboardLayout>

<script>
  // Toggle agent active / frozen
  document.querySelectorAll<HTMLButtonElement>('.toggle-active-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const agentId = btn.dataset.agentId;
      const wasActive = btn.dataset.isActive === 'true';
      btn.disabled = true;
      try {
        await fetch(`/api/admin/agents/${agentId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: !wasActive }),
        });
        window.location.reload();
      } catch {
        btn.disabled = false;
      }
    });
  });

  // Save behavior_overrides
  document.querySelectorAll<HTMLButtonElement>('.save-overrides-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const agentId = btn.dataset.agentId;
      const ta = document.querySelector<HTMLTextAreaElement>(`.overrides-textarea[data-agent-id="${agentId}"]`);
      if (!ta || !agentId) return;

      let parsed: Record<string, unknown>;
      try {
        parsed = JSON.parse(ta.value || '{}');
      } catch {
        ta.style.borderColor = 'rgb(239 68 68)';
        setTimeout(() => { ta.style.borderColor = ''; }, 2000);
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Bezigâ€¦';
      try {
        const res = await fetch(`/api/admin/agents/${agentId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ behavior_overrides: parsed }),
        });
        if (res.ok) {
          btn.textContent = 'Opgeslagen!';
          setTimeout(() => { btn.textContent = 'Opslaan'; btn.disabled = false; }, 2000);
        } else {
          throw new Error('Save failed');
        }
      } catch {
        btn.textContent = 'Fout';
        btn.disabled = false;
      }
    });
  });

  // Migrate / sync button
  document.getElementById('migrate-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('migrate-btn') as HTMLButtonElement;
    btn.textContent = 'Bezigâ€¦';
    btn.disabled = true;
    try {
      const res  = await fetch('/api/admin/migrate', { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        const seeded  = data.agents_seeded || 0;
        const details = data.agent_details?.join('\n') || '';
        if (seeded > 0) alert(`${seeded} nieuwe agent(s) aangemaakt:\n${details}`);
        window.location.reload();
      } else {
        alert('Migratie mislukt: ' + data.error);
        btn.disabled = false;
        btn.textContent = 'Database Synchroniseren';
      }
    } catch {
      alert('Verbindingsfout');
      btn.disabled = false;
      btn.textContent = 'Database Synchroniseren';
    }
  });
</script>
