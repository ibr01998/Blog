---
import Layout from '../layouts/Layout.astro';
import CtaButton from '../components/CtaButton.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import { db, Post, eq } from 'astro:db';

const filePosts = await getCollection('blog');
const dbPosts = await db.select().from(Post).where(eq(Post.status, 'published'));

const posts = [
  ...filePosts.map((p) => ({ ...p, source: 'file' })),
  ...dbPosts.map((p) => ({
    slug: p.slug,
    source: 'db',
    data: {
      title: p.title,
      description: p.description,
      pubDate: p.pubDate,
      heroImage: p.heroImage,
    },
  })),
].sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const featuredPost = posts[0];
const otherPosts = posts.slice(1);
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION}>

    <!-- Hero: Featured Article -->
    {featuredPost && (
    <section class="relative">
        <!-- Halftone hero image -->
        <div class="relative w-full h-[420px] md:h-[520px] overflow-hidden duotone-navy halftone-bg">
            <img 
                src={featuredPost.data.heroImage || "/blog-placeholder-1.jpg"} 
                alt="" 
                class="w-full h-full object-cover"
            />
        </div>
        
        <!-- Title overlay -->
        <div class="bg-[var(--cream)] relative z-10 -mt-6 mx-4 md:mx-auto max-w-4xl p-8 md:p-12 border border-theme">
            <span class="date-badge mb-4 inline-block">
                {featuredPost.data.pubDate.toLocaleDateString('nl-NL', {
                    day: 'numeric', month: 'long', year: 'numeric'
                })}
            </span>
            <h1 class="text-3xl md:text-5xl font-extrabold text-navy leading-tight tracking-tight mb-4">
                <a href={`/blog/${featuredPost.slug}/`} class="hover:opacity-70 transition-opacity">
                    {featuredPost.data.title}
                </a>
            </h1>
            <p class="text-base md:text-lg text-muted leading-relaxed max-w-2xl mb-6">
                {featuredPost.data.description}
            </p>
            <a href={`/blog/${featuredPost.slug}/`} class="inline-flex items-center gap-2 text-sm font-bold text-navy border-b-2 border-navy pb-1 hover:opacity-70 transition-opacity">
                Lees verder &rarr;
            </a>
        </div>
    </section>
    )}

    <!-- Latest Articles Grid -->
    <section class="py-16 md:py-24 px-4">
        <div class="container mx-auto max-w-7xl">
            <div class="flex items-end justify-between mb-10 pb-4 border-b border-theme">
                <h2 class="text-2xl md:text-3xl font-bold text-navy tracking-tight">Laatste artikelen</h2>
                <span class="text-sm text-muted hidden md:inline">{posts.length} artikelen</span>
            </div>

            <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                {
                    otherPosts.map((post) => (
                    <article class="group flex flex-col bg-white border border-theme">
                        <a href={`/blog/${post.slug}/`} class="block overflow-hidden duotone-navy">
                            <img 
                                width={720} height={360} 
                                src={post.data.heroImage || "/blog-placeholder-1.jpg"} 
                                alt="" 
                                class="w-full aspect-[16/9] object-cover group-hover:scale-105 transition-transform duration-500" 
                            />
                        </a>
                        <div class="flex flex-col flex-grow p-5">
                            <span class="date-badge mb-3 self-start">
                                {post.data.pubDate.toLocaleDateString('nl-NL', {
                                    day: 'numeric', month: 'short', year: 'numeric'
                                })}
                            </span>
                            <h3 class="text-xl font-bold text-navy mb-2 leading-snug group-hover:opacity-70 transition-opacity">
                                <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
                            </h3>
                            <p class="text-muted text-sm leading-relaxed line-clamp-3 mb-4 flex-grow">
                                {post.data.description}
                            </p>
                            <a href={`/blog/${post.slug}/`} class="inline-flex items-center text-sm font-bold text-navy hover:opacity-70 mt-auto border-b border-navy pb-0.5 self-start">
                                Lees meer &rarr;
                            </a>
                        </div>
                    </article>
                    ))
                }
            </div>
        </div>
    </section>

    <!-- Trust / Methodology -->
    <section class="py-16 px-4 bg-navy text-cream">
        <div class="container mx-auto text-center max-w-3xl">
            <h3 class="text-xs font-bold uppercase tracking-[0.2em] opacity-60 mb-4">Onze methodologie</h3>
            <p class="text-lg md:text-xl leading-relaxed opacity-80 font-light">
                Wij testen elk platform met echt kapitaal. Onze reviews zijn onafhankelijk, data-driven, en gemaakt voor serieuze traders die execution speed en liquiditeit waarderen boven marketing.
            </p>
        </div>
    </section>
</Layout>
