---
// GoogleAnalytics.astro — GA4 with Google Consent Mode v2
// GA_ID is the public Measurement ID (not sensitive — visible in page source).
// Override with PUBLIC_GA4_ID env var if needed.

const GA_ID = import.meta.env.PUBLIC_GA4_ID || 'G-1NZ4VEDNHF';
---

{/* Pass GA_ID to the client via a meta tag — avoids Astro's <script src> bundling */}
{GA_ID && <meta name="ga4-id" content={GA_ID} />}

{GA_ID && (
<script is:inline>
(function () {
  var el = document.querySelector('meta[name="ga4-id"]');
  if (!el) return;
  var GA_ID = el.getAttribute('content');

  // ── 1. Ensure gtag + dataLayer exist (BaseHead already sets consent defaults)
  window.dataLayer = window.dataLayer || [];
  if (!window.gtag) {
    window.gtag = function () { window.dataLayer.push(arguments); };
  }

  // ── 2. Load GA4 library dynamically (Consent Mode controls what is sent)
  if (!document.querySelector('script[src*="googletagmanager.com/gtag"]')) {
    var s = document.createElement('script');
    s.async = true;
    s.src   = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
    document.head.appendChild(s);
  }

  window.gtag('js', new Date());
  window.gtag('config', GA_ID, { anonymize_ip: true, send_page_view: true });

  // ── 3. Helpers
  var CONSENT_KEY = 'sn_cookie_consent';

  function hasConsent() {
    try {
      return JSON.parse(localStorage.getItem(CONSENT_KEY) || '{}').analytics === true;
    } catch (e) { return false; }
  }

  // ── 4. Scroll depth (25 / 50 / 75 / 90 %)
  function setupScrollDepth() {
    var fired  = {};
    var marks  = [25, 50, 75, 90];
    window.addEventListener('scroll', function () {
      if (!hasConsent()) return;
      var scrolled = window.scrollY + window.innerHeight;
      var total    = document.documentElement.scrollHeight;
      var pct      = Math.round((scrolled / total) * 100);
      marks.forEach(function (m) {
        if (pct >= m && !fired[m]) {
          fired[m] = true;
          window.gtag('event', 'scroll_depth', {
            event_category:   'engagement',
            scroll_depth_pct: m
          });
        }
      });
    }, { passive: true });
  }

  // ── 5. Outbound + affiliate click tracking
  function setupClickTracking() {
    document.addEventListener('click', function (e) {
      if (!hasConsent()) return;
      var link = e.target && e.target.closest ? e.target.closest('a') : null;
      if (!link) return;
      var href = link.getAttribute('href') || '';

      if (href.indexOf('/go/') === 0) {
        window.gtag('event', 'affiliate_click', {
          event_category: 'monetization',
          link_url:  href,
          link_text: (link.textContent || '').trim().slice(0, 100)
        });
      } else if (href.indexOf('http') === 0 && href.indexOf(window.location.hostname) === -1) {
        window.gtag('event', 'outbound_click', {
          event_category: 'outbound',
          link_url:  href,
          link_text: (link.textContent || '').trim().slice(0, 100)
        });
      }
    });
  }

  // ── 6. Newsletter signup tracking
  function setupNewsletterTracking() {
    document.addEventListener('submit', function (e) {
      if (!hasConsent()) return;
      var form = e.target;
      if (!form) return;
      var id  = form.id  || '';
      var cls = form.className || '';
      var act = form.action || '';
      if (id.includes('newsletter') || cls.includes('newsletter') || act.includes('newsletter')) {
        window.gtag('event', 'newsletter_signup', { event_category: 'engagement' });
      }
    });
  }

  // ── 7. Re-fire page_view when consent is granted mid-session
  window.addEventListener('sn:consent-update', function (e) {
    var detail = e.detail || {};
    if (detail.analytics) {
      window.gtag('event', 'consent_accepted', {
        event_category: 'gdpr',
        analytics:  detail.analytics,
        marketing:  detail.marketing
      });
      // Send a page view now that tracking is enabled
      window.gtag('event', 'page_view', { page_path: window.location.pathname });
    }
  });

  // ── 8. Init
  function init() {
    setupScrollDepth();
    setupClickTracking();
    setupNewsletterTracking();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
)}
